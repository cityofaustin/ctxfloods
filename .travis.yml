language: node_js
node_js:
- 8
addons:
  postgresql: 9.5
  apt:
    packages:
    - postgresql-9.5-postgis-2.3
    - gcc-4.9
    - libstdc++6
services:
- postgresql
jobs:
  include:
  - stage: Test Backend Locally
    before_script: cd backend; yarn; yarn init-local-db; yarn local-drop-rebuild;
    script: cd backend; yarn postgraphql-local & yarn test
  - stage: Test Frontend Locally
    before_script: cd backend; yarn; yarn init-local-db; yarn local-drop-rebuild;
    script: cd backend; yarn postgraphql-local & cd ../frontend; yarn; yarn get-schema;
      yarn test
  - stage: Deploy Backend to AWS
    before_script:
    - if [ -z "$AWS_ACCESS_KEY_ID" ]; then echo "AWS Credentials not set. Skipping
      deployment."; travis_terminate 0; else npm install -g serverless; fi
    script: cd backend; yarn; yarn rebuild-and-deploy
  - stage: Test backend against AWS endpoint
    before_script:
    - if [ -z "$AWS_ACCESS_KEY_ID" ]; then echo "AWS Credentials not set. Skipping
      tests."; travis_terminate 0; else npm install -g serverless; fi
    script: cd backend; yarn; yarn test-on-aws
    after_script: cd backend; yarn; yarn rebuild-and-deploy
  - stage: Deploy frontend to s3
    before_script:
    - if [ -z "$AWS_ACCESS_KEY_ID" ]; then echo "AWS Credentials not set. Skipping
      deployment."; travis_terminate 0; fi
    script: cd frontend; yarn; yarn build
    deploy:
      provider: s3
      access_key_id: "$AWS_ACCESS_KEY_ID"
      secret_access_key: "$AWS_SECRET_ACCESS_KEY"
      bucket: "$S3_BUCKET"
      skip_cleanup: true
      local_dir: build
      acl: public_read
      on:
        all_branches: true
env:
  global:
  - secure: EtBssrKXb0PVG9tgLarelamL9T6xsTGm+TqX97lUs/ekq7iD5KM2rWYgd1XHcE9d+6L4P+iflUwuahfbWENLFDRda5iHRFc96GO+7byzySn9n2turVcy/wsc9KZ8u2USk8PApzcXeLb+XjcaAmAdvf7018hayRkrbDAQXchHfaAEeJOOY/lJIxouxaIbcM+02wYAhF4G1Bza8qR4W1xZw4HvJxGe49DPmNFhrbJMryp6b03NxSx9Sb63E2LbpRAMUIAr16ZkIb/C/uAs7Sjr8W9CZZgpmbjWrwTtaZJC49wBR4rKonFttcKI896MvDn1DcdVy4+KwuIu0UH4weashByyb3AR0Hy5+OuveGj+1jvzK4wqJ2muy+YRsuErMYUtwYzdb5hwH0EC4ieSmt+tesZGocL/5T/2eTZO+rggP7CpBrlDfwTsI3SHdsHLNAogvPfqPcF61jvVqzPbnvnsYBtPaobBtEw2Q/+NNAnqKIqD1il9IaC6LLw99YHbxgM2NQILO5oPLWp9FoyJuRlqZe3WKNV78RqhpHSViUpLXEpxqV0ISdL+xbk3/yjn8s5S6ATHuuxHX89aTD4YUkm3kJpSEEQxXj7jLxwdCn6lfeAIifG527dsmEoGSNbOKFUg6uQjAY/RYQbyVWVlPbLR623v2QYOfncMUalrO1rQkOw=
  - secure: z3RueHis+6BynuNtPevVXg9gZ3o7zU6eVQOLGC2MgXWLKxsLsCV03j4yhIaJm7XAuoVeGOnKbVOnC+cE8llV33mJQjkxhPeUWxj89RVxce/DngFsWm7Cmb059CBqqDn6ZRlFhkDMxPhOO9bmBnpRiBS4IdC1N0+CPqI+AmI0By5TyIZm+CXVZKtQ6brVdhHuPpokDl6a0uIHCE4mIYBU5815oALruhRg+HnclV2mBKFO0+eb6/jzrZCb94UksDWLnxLTWg/ykc6pkpcNyUAvUr+C9nSGi2b5CxTY+ysWMX6HzeK+jLMLLlqLaY7Bf94zIIrV11SjF0sXptGEIXCAyM5x8znsUKWQpwLtQbd0B+oMcoussvVM69TyOdZ8/vq5RuFVqETETDmjCXKqMxkDw9zjvYKypeoDg/PlcQgOTvSmeEbVfyxEpA5iyeSD9LvT7kdjTymUuNNOVbE9lBFmw76eMAUKHenvnnMyMj0bLgDmCYWznB8dBnNU0OhJ5iYw48hLr9LVmibrhwj2fS209N4yHb5Z7edKJnMl5zf10He85CmjssTOyw4/vqAGr3ScR1u2RmqUec12W3cnuCkJN6GGk5vUREF4U6J/LDRLPFO9fQQA9ciIS/ZYfvl4gIdpJdxS6fapKDuEMpaKzPbqlXC7JlbqqIrlSKYewvTxvx4=
  - secure: PWFgBY5cdG+zbRUlkySLg2pqthybRY7j1KLPl8fibUal0hd2P2g7aY8FrumI+deV4YyoMaMsiS3DPb+YHGji77dr5R2FSvsdxdRsb5TUvef4e3Q+YwNU1yPXcrf+HaoBUMMuTGThcsYKqfeQxTIFV2F+sN2/ZY4FDG0n6xEiK+kQB/LevrqEiWbW1Bn4kmgkbb3xkN7YOm7XVdYLVatVmLhedAzuJQ6LX03/L2CoqGRs9dV4zLWFXT70MO4Jg3wgDht7ms4+kANhfkeZeJbAETY/aqz9IhC3lKzbGfmciGNMtcdbFTkj2+08QNTjC3YfOL7nHk00p/AM8q3jU+L8cz3+5789GYObpCON1kOIX0bBty67gcwjnndME/TVkwYnlMgrkv+c99V2YAt+yDujA2hIP34fQ4NpS4F4F4IL9a0MQDPmzEmgdsT0ZfnshDbK3l8jrZRWbqbFmdaK8sNaGoLEhenB6GBmj7r+YFaVIirnsD/h24QImbA58PRl38xnBC6m6s5iLyIk/Rgxe3f5SNb2o7Uwtt2QKJN+TGmLiLVfI2L5X6/xI9Tvsw6M0XjKS5zq9yOo/Z66SMEtqOMAuhAx+td+GNn5kdQ1dvhxpWTaFTVBeMVsC3sEpHnB0B0KDH67ygZLRm7JYeM3gjkhqQwUdNl+FzmyNIGm5di/4a0=
  - secure: EvuC1S9b/mlSNLATwQioFOw6MFBShyAdbFpNqlnCoJyGmHmbVr5Y1zFysRh6YDO6FNqSMH4oa0I/c6pkLpN9eBideUyCSdGWuiDVTlJxXeFd2/5st/JHMEw5GScShH1lffGXzh6NPq3GOt5+Sz4A+fB4R1PeIMTM/W2j+qgk7q+ARAiaF3+5I790E7+4s+O/4yg4DPkFA7EaJcn32KpX+9s/b20oHJJn1xwny6trHtnYhjsjVSGo3SNDtMUx8HnzasOq5Q7YMRihL5kPfXHBMA64GaOsv/MnQU3jnp01gEaJQlFnTSamspofGnA7eaXzbliTai7v31QlsD9UzcrvWOOUQqIdOfyKM2eM0neMPOpV2kLlU5pWOxq3uZ9FwtjLtPpctivotoB/khp7O+9fxQeFJGC4k4mxAKbMb6jXrrOF/FfxSUjH09e9NLp8Kw0zKBehovtvUWDNhTEdENOH4m0f3liAaQCTGrWqABS9V9P8fry9wUiWRmabpGfsjuyrpzPq9UNUm/t9cSnaumu0Y7UGVGuAbfMmj9xrM8RCkE3C5XLuhJk9ktunSwfPpcKRPJAunyctT28Np5Jf/d4yd1w6+LwORHwN2n0GDQKokiJ9B6+YUjMAc1PucdaanW/s9u89e4aHleu9pWhaM6R2gfSK17W3No0xA0P/j5ryqik=
  - secure: RMWf+MEL2a7pWPBSLMKwY3KXPSNGbL0tgJvECWyRVyYNv1xTn8VCBglU00F61vJ0g2rmUJs5n1m42cwGQspftcUOxM02nvVyx2mWEZec45AeK/lXRAaY5DbrAt2E6xhntgJbbp1hMODfFlXugbo1w1FSrHUSpI5EgprxxSu2EKiopYnp6L6Mk9IuMFtkvmo2+yvyxErBGZldw8HASjt1lyCS4Ol7H1QlDayflh7INZJnRjUoFj8Xsxn0/pRR9vUUr+OxhNGmFNGCq9+AEEg+T71sEdun0OXG1v+mrCMqtO/cKGe7K3EjGRv4GAiHc9qYvq+oSWyIWZizmef3hugPG/8MJGcNKCBqj9PxGzThzsf4NN91WgUGU5aUlspfBa0Zzrw5xBHq6ToqSG/WhVYWEqpOWFDFabUxPDAhEAKXcOaEtLRqNwFEySmjbSYSQwCgYzlnNkHjnEjwHSbd+YCvJY9pGpyqFXk6q+lYTR2cF3Fd8I1uxjsY9yMYJuB72Q3+qHo8TYvpMfD3Pe0pStBrsvmBbLzojJwZVnJ6YIhqUoU/782qz033pwcVrFfRpLtGfxX9rq55IGIS9f8AA8GGIM0Jbk0yQ1og8XwfRz5Z1usp1HFeR1BJrGOEPwAO3IS1eF3QNEIs+6/383JMYQURu8seKkMKykKq0//hzWLkztA=
  - secure: H6mfZp8B6gn8a9I7PI9GF4bskyoHFHuwSpTqpYj4NM6f9H16iUbJHryKjGiW9tnVwrmvARL27t3/xSC2/Ez8iHctopluCw4E/T9Asv3Z0ystawW2herCHezS7AAyEQ17cYzzE6kxx+DFR/qP6FIZNLavO+EDqIztqlMohgFnbBBy1pBCvRJKRCr9q09wshP+KZ5KCccPoorBCkIK2QxcimbXeuuOuem8gpszooMMlk3XimVL/nM0JNGDcVMfWRsTAQfYYo8gkFC23eCamwYMD7cMjjeunlGe0Le2/KVCmwi2Z9O3Q1WbRyUhZKdSeOJemFtS2T7a0Xkyg72yiYUg4cTAHfymvWyJGdkw1eG6qn76UFoOtCLnzuYA+pdrucgH6NXKPqKy0j/0kJtI73j67IwBTdIoOo2safxx0Rb3nOIyEYjqKBCvq4G/cMB3s3pIIKVF9XuuzsZqfD+ZseFv9oGjso6SrHATbNg85p1ednwMAGoJkkebTFwJEkieaxaDlfVC5NFhI5ZHdMmVXFGW89itg6tx58EL8MPqjx+YYtw81eBKjWUHkRUog+iApIBlAVchZLpG0ga5u0QYHg0Wh+OwA98HvfweYtGHWRKzlSbRLbVINPrzypr873S9EUfyj10kVSXjiWAY7tiXxXjRKQkCX6yxY0ppDdBqxQcOx8Q=
  - CURRENT_FLOODS_BRANCH_NAME=bds-deploy
  - S3_BUCKET=ctxfloods-frontend-bds-deploy
