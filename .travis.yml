language: node_js
node_js:
- node
addons:
  postgresql: 9.4
services:
- postgresql
jobs:
  include:
  - stage: Test Backend Locally
    before_script: cd backend; yarn; yarn init-local-db; yarn local-drop-rebuild
    script: cd backend; yarn postgraphql-local & yarn test
  - stage: Test Frontend Locally
    before_script: cd backend; yarn; yarn init-local-db; yarn local-drop-rebuild;
    script: cd backend; yarn postgraphql-local & cd ../frontend; yarn; yarn get-schema;
      yarn test
  - stage: Deploy Backend to AWS
    before_script: npm install -g serverless
    script: cd backend; yarn; yarn rebuild-and-deploy
  - stage: Test backend against AWS endpoint
    before_script: npm install -g serverless
    script: cd backend; yarn; yarn test-on-aws
    after_script: cd backend; yarn; yarn rebuild-and-deploy
  - stage: Deploy frontend to s3
    script: cd frontend; yarn; yarn build
    deploy:
      provider: s3
      access_key_id: "$AWS_ACCESS_KEY_ID"
      secret_access_key: "$AWS_SECRET_ACCESS_KEY"
      bucket: "$AWS_S3_BUCKET"
      skip_cleanup: true
      local_dir: build
      acl: public_read
env:
  global:
  - secure: NwBQpGpUjnLWOh/AjTbtlOpYSQCCqXr/Ij5oz+WyBvUhUcsRdms+5JcTSGCO4Co3OYt/bWRdDWGzejwmJpEQs5eUXsIFbngaBe3ehSM1OE8Y06Zf+W7d/1LhM0M4EIINy7QcLhSpEsA9pXTK+Epgt75bG465UbELk34mtXtLhNG1YodVQ14jLfzR0Pki6cNgavECX0Jj5Kfxlrn+32qcyNG3OEKSnb1N5soNBkjsK4UJAJUcJxjHx1rLJj3PRU31XiXgurAnjfHpq07eKWHcrkQ3TYD3jZdJtb0OH+NmzdLOoQtHVtj7ryfyyyhP9eZiFx2qA14GGH5uBpz2YB1frGDKEz4vIDwq+MrDbouTisEwShq6MNcfiRi8M5D0sfedwR8ejiBkkW4+kRYCianJS6HWlgE2JPwDB1vtEZGJpatS7Djvhm+R2QTUIqmo9sFveMMl0m1/8R1CAKUOTePMfYXkxNc+TSGP8AC3UyDV9t6MxtzlGgSsneGIzbGbqbQauo7sf3up75qq1V692m3L/fTV5KTIZg9lMJz4yHkB+1xD48iVf6U+U+n+xjxArk0J5jA3NtSJsHWvcup2H2eAx2b7qXMxRp5D6sKOXKuUxQUAn0pK2q2m7B+z1kI2rCFLZnG0aXNivsGWxbs6alkJzbp3VPHhXen0g3iEiMWFKDs=
  - secure: Z3/hKWSNOwk1jqw9XzIBUvsGbK6gHo0sSFszYMZqZtfuhO6DxPhOdVasREDKniIT/WiLRsFS2RzaR/f7V0Why3VRDpTssnwatoQVB9gGt/HND2RgFvVYU0dkZ21nHpYRsT/d6hm+5HkCNss4sswJ1GIpcxCbxmHs7z5VnNYGekElY2rUaCsyCYOHpcrIg3Z8AYqip2fj/VH8A8GjXjWNG2MJwR6vPXFLZrlCWBoBBHbcTPA7kBwwygX1FHX2OqhqOagfupAnLtlUpWMFIgkG9E05qGaYFaJX+8F8i6n1k2ZWgSVyxqrRyh7KUxKQ4spNt2b+UpFHDytGk3RykNWdfXqY2KUJd9QAlBAaDa1kY1K07GIxb95SPw5w186kXJ1nxwKLHDt4MShDye5zOIxb1XqUWYD4mKscWC8Kd99X53Xw9rJ1qHmb7mRNQtIuLKielndU41Z6aqkpvTs25HPy1gVYHwdP7n5spg1nwKYYVxIXYsYv6I1ON2j5xZRqUeQhrob+GX9BvTMkNxgkiYmz0rRssUxYDXe6kYB7aO7tA+/DvzrPNLhHyekTJV5t0MWOvQKGvYXYUXi/tM1ARtqTOaBYCeuEYXpjHCXzQrWdqFFaqOp/8Yfpph+Ta5/+7tpIDev2Zj//R4mPrI7he+OVmjnzgcdS5rVXg3phVPYFXMo=
  - secure: EtrPgXX8JmSclACG9Z9CXclRKkjzUSNHHfSIJjEVoBa0oGbBIhM4QopPphboFiRU1l+/whCjLXJ7nEHzxWWYlNaNMHVNQAL5m+KhIIuCRzD3h+oJbCRxuf2rLn40Vannu4JzhXrNtpxlq5fbKCsM7dihlVqho8kgCbqrCp688q4OheaRtMxndcnW0h/nHEks0unJGCN7orObSNn/k6olj1jph7oS2MEIqkUwA1rIXbpJUWFt0GcdyyHYB7LF5H6epjRk0Tq8FMoTFHQMTL7LdR7eXhWAuo1jE731YdeunsZfp4g0kcyWwJDZzD11chgdYps/li6T2HM1fNOi5mBL85qfO9GVJXgzKgKa58NdjKEU9fI7U0LwipA+wZQC+Xa7NyLz1D6kbovghmb2G/VLVR06xzlCQGHJj9XWEKZcgeSaVnKkn4vxXC7g04XFr+6HHxzcMCpSDYi1pM+AUY5Vo2c/K3PQzoPpdSEwlS6XDO28fo1f1dw16cYHNg8EH1hxid1uKIwtlDWIi47mvFIgjnaBhS7KyI74YeyWsidpK7Toa1/Bti3xI/l+8T2rJyBfjr3mG4sKlUWxj3g+9Q/hSFJ6EshXyyvI/8bUI2huPdrrsoHjUOlsTiFtz0B/DxLcxb+sPbvDvCG5b/lImILtmr/JWgXY9Rnj1EmlT+E9qFI=
  - secure: l5wxnUM/AUECGzpwM/nVArFUy5Bvqhy2lf3UECj6bfw6Go21G5vO4Q8nK1LYb/YXxOdEq+4v/GrPo47eTwSpUb6/fnzMktLhQebRUa7EKhvzyAk7KeGkH4NA5I1ZvTsjYJuALhoxu7qwvtlXW9NOAD+cxb5mAHAMaG+v04Nirlc/aiwesb8YVyqCw2TEuwGTsbf+5Er3sBY6geUHO75LMtGCGhXdgbjgnBK/bt2hiiR85PYVmsUWK58PHnqe70qAss1A2RIdVe7W8JmFXukanHU06LdLpKNFQ9ocyhWDm1H40T9WFtrx/OBISi385jW94ekU6KFkF3pDi8tlasqiYlNspHzsXs2lGHO2mOWZHFLrqJz4x6ZtNAJCa5csLCXhgQifb9CJ+2Pi9akoHAiEspHDr38A4BVFt+23BASCKyF/gudhc/efW3ia3msXZ4gE++1WcHxZ7u07k+ysEhL3q0brMKmZGsyE3yUBcCJxjQKfyHOKw4+SakeZ/xB7OqehkLeOcKSN5XQ6nPBPFDNeXh2Qdfm0hN186z6KkXCv+t565ddAYu4/AA1OydHd88ClueicXf484mvyy21BfyYcdyqzQOlDsgvc018jvLNT0++mPZMl/ZI+VWtKy9fgvu9CMQl5LczWFYdgcrAEZa1ENRQrDIDugaFstgrodIaFE9Q=
  - secure: cx8ykNopptAHtYwdtgYA5kuN524R/ud9cI/K+tsAGMBV7S5SVNDpS23ziPP1wLcH/fXgRcgpV0hVGUX0dMdS3+R9jADAL2nfoQhV2vR3wM6Yqr07imSriWpKPeMoxxmVTj4JZeYjlVZl/+8uMghiklVpEy8OE5ZW6/1X25AcLBPc+6E7nDm0f66yFRTnHwVz348doiTfrq+3FJf04qyiW7MzzLv/MHoQo1ZJEQracCtVp/+SLRjZ16FqfEoveQg8DYKtVHVJrwm4mYITrs4V9Tst2shFRSx81vYsADVOn2oVacxOZF5zere68qcg0o+2/QImNiWB4GaGQv7zqQRpfJnEc++BE7Sl6/16vBmDZrTp0/7sG8w1BuuxPG3npIiDz52Id1Mz4oDiZVSRHB02t8E24cXKNehbU3xOLqA8AccGGAAtDBP8cN4SwpZRk7HbP5LkHRJtY8jyRznpJwstRL1dQDQDsrUnIne9qjsD9h925DbQXX1cE5lqv7OCZq49FH+9Z8YLXv0dT2vN2PWxiaUBrOmh2RgAGwKeKHC0y7nQR4to1hkSI9eH8xa2//nlF/WL+nghaz2zPiArEBDCuwFTFb9F+uJsEX5FaP+0Msd5MFKAZbUVOpk2m41+aNgQ+FrAx8+8ZDymn25CSlXnqHHDB01wtDd5peBdPROGjkI=
  - secure: g2BoAEmUTU+2ZBY3/wFENt0Zy9WmNcr1FFYK4uI2EowE0ReAKWEQzCucfsPPu4XM7SeJIALC1oNxGmJa1YnNHwMGoIZErRSCIEbQSP/W21nXcyLGGFoB/9kpNHm+j6YpxKIJarzYWc1jZgBEr27tx56bcF607iTaznrssQ7oIf3K8cZf7W78vILa8bi/GjgIPcA74xGwMjbw76yo9ogyQeTQ5cV+v4lPJXrZmBNeA/MdPJSN+jmGrx7I/n741yA7dZQyRqsZI92oEHaP9//+zgS78jU4lw0wWPIB4WMMPatE3Er5hRtYt7W++RemEKY+jgPTgoEvfO1i+Ce9u+YJ+cVTKiTBAgr5ceNVi6OABooRTU4gSW4wy13W/kZ04cPTJyVFk9otyaVzpZGle+dYFTrXZK+hUZqzJMe+Isc0UxKsp92/HJyR9T6sMt9pV82jhvQ10IBkEEWqedYmvDuTiZ0naFTxmXrrMSf6VhhlcCYVN+6O0tRsSeY+OKTzWRGU1fKV9kbefl6uyc3xn+ojNYAf7crTLioPn/VypNK6QIYLek4636YNzv3KrNXrNSp/cLy/52ssjJDJQfz4aXB0U02zXTDX7DXCpYo47ZGj1Mjg9n0UvifDvfYZFZpHSDCwy4ZA8sCMrVAPtLbsgopFeAAYB5caW0QrRRhtoqUQkiU=
