language: node_js
node_js:
- node
addons:
  postgresql: 9.4
services:
- postgresql
jobs:
  include:
  - stage: Test Backend Locally
    before_script: cd backend; yarn; yarn init-local-db; yarn local-drop-rebuild
    script: cd backend; yarn postgraphql-local & yarn test
  - stage: Test Frontend Locally
    before_script: cd backend; yarn; yarn init-local-db; yarn local-drop-rebuild;
    script: cd backend; yarn postgraphql-local & cd ../frontend; yarn; yarn get-schema;
      yarn test
  - stage: Deploy Backend to AWS
    before_script: npm install -g serverless
    script: cd backend; yarn; yarn rebuild-and-deploy
  - stage: Test backend against AWS endpoint
    before_script: npm install -g serverless
    script: cd backend; yarn; yarn test-on-aws
    after_script: cd backend; yarn; yarn rebuild-and-deploy
  - stage: Deploy frontend to s3
    script: cd frontend; yarn; yarn build
    deploy:
      provider: s3
      access_key_id: "$AWS_ACCESS_KEY_ID"
      secret_access_key: "$AWS_SECRET_ACCESS_KEY"
      bucket: "$AWS_S3_BUCKET"
      skip_cleanup: true
      local_dir: build
      acl: public_read
      all_branches: true
env:
  global:
  - secure: sYuiqN8chkbs5QKBGQgCaw8pTzahLrrFs8K3BClq9qdxpkr1pFvJIemP8VrMLaR6wTzs9hJoSSHDCdaQ+hmsFp16HjiKiZD6Hiu9FnvY9AztPZCNBv887fc6gqgLORS7wbk77v1YaS5pLjoV4KPkS37YwerbnRaiWaXhryKft1kXdUVx4mhsXPqCGgMXsqlr9N7O4fNLw3VL62doCbH5sQAyB9UkYiYf6/wavwverMSA7dRZeVkEtE0RIJ3OZ9pfKw0TLVxraYHEcFkKwieYcvWggyZf+VWGxG7Ub7VTUb+b8c3gB6KMuyyIVP35i+T/yPVr5Z8qum9cMwq0vv1n/9K9U5wiFhLA+/AqzSUFwtktNAYzySV12l76jbRVaiqpLvakYPzx9+FiW7JN95SvChremnftSssWI5l9wmI3Z6etZRXSNEknIvGG7zixSb64XmUIqPyYEAEedfnS4d50c7n1Z3b+sHY37ydbn/ndlo1cR8aTjU+JoPy8lfcJyc7p1y8eLPFEWVGrsqxt3O2wRFCv3GpPOR1Mm1fp7/XEuIuLkrZmlVpNe0S5uRW2+to5Om7u/TvxtL/DPzEoJDD27tbED5fp4dxBPHgU4X3hCfuLj612ecT2OkAZdiqlyg2/pIhyJc6Yj2HsjjIkY3BhceXJJVOVNtT8O2BK5KUnPiw=
  - secure: v0GZJm5dBK1EnUZ1o4NxCLB07U00g8/zcY7TsRpDJWnE7pLdrp5q0WX5oHnA0ISr9SPOGTSCxqyCrDlrFGidQTyVd1TjQckfDOw1YAxOniV/6eU3MrtjXidEJUzqUtjkBV5/XoS8dGSWAM/EN+CKPr/tZJBmtnW17NC7iDtMV9QjnX0QjZbP/wfaQnVAXD4Gfpu22IyEGSjdbdC9BnAupZeNyLadWUKx1I6Ge4ojbdbcD0ovK5dgPiUAx/W+tDoEk+pV9e06H/knDmVSmyq3BNMDZrW1QE8AN/yV5jskf4dFWuwCgUWOm+utr6LNtRqdf+SxVOjv2uEnAEBiIbmZSZ01aRrVSIgBIdRgTSDeJI31jGYDW32k37C54sZVkOBg6lvshHHPjKTFTrrvxCS3ZeBFfDZVjVjsD7VBd3jQgPgDFcztnVZs7fs5OLegX3oGYMLxDKqIChEUdmPLy+zs+rV76raKnaXsqTmPJxxPM07kfoIhVoWMHleKIWYcU6EhPMBRIHbQiEvbGdMVQ639+JkGOdbjUYvcbWHorMsITutWTDgPoHWp7FF0w9B6kqcwGHN6HJ1UNBhgTpZlJAlQccMACbGg9VOAwjnGeJalF0I3meMB7QpZocAiRVfTLekWADcAG1pDzDST5uO/fzu2OrvOlMcNXWDsbL56dxte0O0=
  - secure: HZMc0vhm9KwHJtOD6kpX27bdWU3qvE7+5LpdnntzU2op+OBSz4QDEEnP2PorHtOflqcGlgw2B/Nkq4ab2sk8A05kD86CmoXST2S83yC55bS2ex3zmHWyFyXkhQQNnlAzj3+Ij27iSatYMtDlrYOvXwAPvr3/gpHp/1hmHEWKasBhcGUWprXlR2FAvZ5K2j52Gt3uTwz5LtVjuyPCXoizdI37y9DZ7O9gotFKxP09GgiBsJsjw+e00WIGU71nRX+mGSDjR+GGUNa6gzNzbVSVI8vLt3UJZNIwVdOAkmj18lBESG86P3uXAS+2jf0B+waNL909VVK7cdVkpaHlibR/PzcjDCemh0vB0zUhkC6j2VACn+tDiX1RtfbfEJ1JAlCszdV06gsXdroO+9jgYk9RMrYeY4l7t3iPdjjFM3uDOsi32gpQ5WXbBNRz3OgnWXBkP5rAuhEhntmk7Gxjd3rq+0WGKUXQTV4FWyQSx/2bUSiItfw6pggNHJHd+aul2NP9nu/b0NKJ0+7gcsudnBj+7+LVsUV3fysgVNwDa3Pny74rCc9GOviouF72ICcXk3GeJ972G22EFwl1bxr9W3CUVKpoIry3dtuYL7WOkfFW0L6Ut8HrpSM/k2nf4in6HGnJfiA24gwePOSDRCevWMK401aCosUDhOBkagJhkjEcdWI=
  - secure: U5xEfyX887dzdghq6E44ged/lDosS1q6eoQc5Ow55yAG/svLmJVv4Tq3TANXvybs7uH4kJ53YBREaLXuMEjJAWFlIKz7h/I15PAz/7MAfK3dldBw/kFY04QumExF7oI9+23IHXMU9YcTsnRbQNRYd/89ohV7ikKiAY2HR3uJ/Cw/CN4sLFDnPXeIUBEyZuC766hknyfeffMcCC3mpXoejoPoj6tFRX2sOMrPIK7hqQ4BKR6SmGS9ztA1DRF8Bwl6QPvz2BPil3MbkiY/M+AnnfmH2ejx2EuMwuVKVwjooxOn4ncJuAMch7jHVLzuxsoA3tPyElgfz6rmOjVUSI2HJQtlj674+96uFUErmL4rPrEADm3+hHA89BvU2OCz63J2/UfdvTIFPI71jj+Q93QB9drSovbn42y1Mz8O8MA7hPo3G+LvSNi9RPhD5V+lgNoUB8+MIDc7f8u2nVwIMI2diP/zddXee5Vp7x1nu7MCuuniheBf7R6i7bY2KUNKOMmO4NTw55Jx3JTIQPLULxzle1JEJHTjnrwHDU6KygPIWipC1ZYRpn284pED8TlGTLWIidvWagnlJVBHEIQwGPGehHVCrgHSyZaKT+iQSZXpndk6KVtwM2LtS96x3OTDQN49YnbzNDsrTuEnjj9vC3kB0wezfw8WkuqhBuwrSC6oB2g=
  - secure: EeWZlTxW9U0iTX+6v95V1OKrB7TzbcaRi19KBxc6OIWF/B8gFmT6uZmk/hZ2JQs+76Av3uWiAA8RMBk4qi3w+mv+esSktQaKB3TNpyVVxjhGxFcfHAKD4oxl5hjsV4gl6BFmn5E/KCGHsHv59p7q/+0F5F+ailIFJFFZZeQmOku0ElkQ87dOuhNC11eMLlrsEVUGsXqSS5Z81mdcea+YgyNmBHMZ1KI1RXdcB6yx6yFSaLqjlzRdHMWMseIGOmxN4XDSWK1IoaWG9jEctC9m+NvWOYaZDjdPhoDTrwNTg56jgy+JWXuETzzCNUpngal89g9aY0GyqfsRqejH9Usy2XkjuVkIICu4L1x8d0OjVayFnf28LKvl/VDH9ejx70Hd1+lhQYUnnBWSZMNBVGlHgl/vbNtZwIKW9I1R4oDWD9ffFrnksPxoLx/ZlD9whw6vLNWGwpzW9tFMiNE8aEySgGBduNQfqijw/L3yOWq+axNuD1MMXEuPBCmLMchcFT/8V94xkPgjKXJ1SUmNZkxzTO34Ohi685IvOX0up85ej5pg73Q0TapZTq3MCRgzgvcL99jbDHWCod27F7XASgY50LmEeH3txDdAVS1FPGIbZ8f+hnSYgYi8ez4WvhtrT7DWcgdQepyKSdoAZmnqy0ZTcnKBEJ3xJgjDsk43atClviQ=
  - CURRENT_FLOODS_BRANCH_NAME=betterTravis
