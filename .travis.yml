language: node_js
node_js:
- 8
addons:
  postgresql: 9.5
  apt:
    packages:
    - postgresql-9.5-postgis-2.3
services:
- postgresql
jobs:
  include:
  - stage: Test Backend Locally
    before_script: cd backend; yarn; yarn init-local-db; yarn local-drop-rebuild;
    script: cd backend; yarn postgraphql-local & yarn test
  - stage: Test Frontend Locally
    before_script: cd backend; yarn; yarn init-local-db; yarn local-drop-rebuild;
    script: cd backend; yarn postgraphql-local & cd ../frontend; yarn; yarn get-schema;
      yarn test
  - stage: Deploy Backend to AWS
    before_script:
    - if [ -z "$AWS_ACCESS_KEY_ID" ]; then echo "AWS Credentials not set. Skipping
      deployment."; travis_terminate 0; else npm install -g serverless; fi
    script: cd backend; yarn; yarn rebuild-and-deploy
  - stage: Test backend against AWS endpoint
    before_script:
    - if [ -z "$AWS_ACCESS_KEY_ID" ]; then echo "AWS Credentials not set. Skipping
      tests."; travis_terminate 0; else npm install -g serverless; fi
    script: cd backend; yarn; yarn test-on-aws
    after_script: cd backend; yarn; yarn rebuild-and-deploy-with-tons-of-crossings
  - stage: Deploy frontend to s3
    before_script:
    - if [ -z "$AWS_ACCESS_KEY_ID" ]; then echo "AWS Credentials not set. Skipping
      deployment."; travis_terminate 0; fi
    script: cd frontend; yarn; yarn build
    deploy:
      provider: s3
      access_key_id: "$AWS_ACCESS_KEY_ID"
      secret_access_key: "$AWS_SECRET_ACCESS_KEY"
      bucket: "$S3_BUCKET"
      skip_cleanup: true
      local_dir: build
      acl: public_read
      on:
        all_branches: true
env:
  global:
  - secure: QBv32XRxKibjYI7ifPjhGYeRwWFtoCd716w96thL8tcOqVlwVBXLw2EV0CmpYTrJAU+kJ7xBUBzAX9Q/1dTkWDD2dygSaQZ7i4s+iL/ksLaDV8N4LifJ3FfbklukiYsN6t+FV9UAxd+KP8M2n8fmo7zzJJ+q1HX2xx/lD3KllvDAk1Zrg1zzc47PNuxThZCtqj0boo+KCPU6uj6usZob0wg4m8zJRsfJClTg21+K6eLWQdFaQoNDS41THf6PYgOPw6fDoXovgpjpI+tY0bPeuH1/L7evkkrYlXLPnaYMt6F0mKxRi6plJjfdXMsdFFWuwgd4pPrKmt9ngqRYslCGTNvSgUeeguAo92cbUI7cXVNTkT4vd7HI9g2eEXhQAuP1X3vwGzqi2v02uIpUVxkm0Q3iDc1SjmS3Y+iP3hPPDg9r1uw+W33AhauZ33Y/EWGW9nwrQciARPth3K6uk7t5w2ySE+8hpBoUrH/Yx4vgSkgDxjx6D3oNR8Z3r9wLv4KbdsZOxiOGcfwZzsIoHiQzWRUcZZTfJAl/hsE6I8zzccc+iyEMx7U4E2NES+2fubYiRQIPIpKE6pM1pDH0DECAoCM1YDDl3SKjMvPPbbvGgZzLgYyCl+BXDzQOKlO0sVK7AT+RGEuyLAmN7Yl6H/+2kkerpXEbhbglaHthlBFkLxI=
  - secure: Tmhyo2FKscp0T2le1y6/sFRAxO/7w6bIRwx2S9LO1VQ5PcsdGjIbhKwJT3Y2CkCMUzyXJxmx6bhzL3xVtiW8ROniFvtj3L2YPzORvAEHc4s2s+8ULp//NCzRVKWpNi1RbTeZpHH1BDHfiK+EJJtkAczP0Je4zgRVZ9+wAVrcYGYV7mEImOwEdT+t7jCynFrpyizd/nPeJKVQIMr18zhobUJW1i04qTkTLHoc3tSlbB6W8A7nePR5CBfcxINnFmgDQ43mUwRTkq9cCLlKgZ6CCnoyP7rxzB1r5KJKi9rgdDfu1oP3C+FsCd4xEzJRaASzf52yhv4c4k2O51+1ADUk6/yOUKloRhwd1X+4loFsG3ZsPoUsuyUqIUvRkpfStVEgfDFUxyqAfbemLmZOhXySLNiaSAd4+tQVj5KEJ/FLOvFzZZbZ5+B1EW+whO+GKYYvmBf8bkPzqtF/z/cEHpJbpaDu0lJC+GZpTnYNo0gG8CvS/RmMiEpjVNPPYuTgbz1iKduPgRj7wo+GVqIDmV80WqGU2Qdg+ElG2TnYbgGOI6T4/Eio2FOa104scy35WIQV6v75Nq8RxJP52D4L+fxjryeL/Df2jGkiROs6YGfZtiKh8/sEmOSSD/L9OSaGEhv3Kf0BxQagRup8QvmFh6n3Obs5H0PVGbQqLbqKm3E/zWQ=
  - secure: rBrQj68SKi2k59O/Hc+UExoLZQPDow2RsucKucA1z2XK+aHXIGz7NKYlwMqbGzMO9UGE0LdlvyIOwmkUJ3kaRMBnuQc3JS23tgPoWepGpVzHFwaGi1Ymx9CNnOhvUJOzNu44yYZB6KJ2i9rlUNyvA4Tr+yXThRpSOGwslDJwdMq8yLNXok06yJQpgyaRapuPLecOG9ccnneRa0MFWPP05JyvaICCsgvOYStiiLkCM7R8LRTdvI5JHMV4iU7p7Kgx8hSqBEx3rYqC/GE/76SrFHk0o2qsnp24wnP+aLWieztdduR8C6jEvvlcJuL3tqscLOC+hsV1bdccNiX7h4GfMmpcKizeawvGxeGRWfRDAVJY2zHW850fjj+NUObxjSGKncFJEAumVpLMa+OqNZTAhNQ7TlqAk+ZYDyuLbq2mkJjDfDCua2RGH5hUDlT1agzzg14kZ0jj9ruoB/aQcGbo/xC8a1KWLv9sUWyU0qvt5FEemgpS6E3j4DPpwXDCWr+El27YIK6iq6cYVuTI3iLp4OlWjgw8FZbs+TIpA3aXeUpSHkh1NgYRT0dnGuck9RGeV4rXtuAbRXmkFkfH6jo3ZxtnvP6vLjUpkoNDZNmTljEJUGKuFs4QPfAX8Ledtl3J+8syX+/msD2Hqje9E7DhFSWidOWNHHBRtYGcneXrA/E=
  - secure: djd2F5zeQnUmS0lZ5cE3rj0tSr+Z34wMfwwk8OoYmNyaVpLnx1zLkU3UhHAySvR46fL9ferOPIwjy6LcyjDwJJxQeYtInM+0Ag+/lku8MOIOtU6tOikAh19cAqfxboMEsKWal5b7XJzwMKGUyPfBvFhFEgTd/4ftGIu7CyvGotKpSv9XkOpHUIgPcrmOcPS9JbYhQWlj4YHVMxjlpExQM2aVm0ON6tqKZV12qOiMt8+vW3nQ0RwTxnj2jAthmYxWnXB4CxlSx5K+cUMfYsICHiC7FX7qOH1hYzNV0jSS5YYli1Ex4EmDUf0iUjuL+eryHfpVRd6oyXPqB0f3qGX3CKhEciSJU9gamBF535lqTYy6t3vnn9fy1MI+3UaRnRYni0TrtIMy5lrbj6UGMrLBeug+URRfJHrwXyv97uBFF8uYG9HL974VaKmcJDUHqfYobNzkfvtsUmF11PXFTXrfLdEQYsIZSRLLBKtQcf474xIgLOqnfAg8E89vUkvY7LFG80yrL3DQnAvfJzwRbgEJZgMo/vXJWViPPbi3dJmi1VredSTajyVcJg8fw2lKUEY6dOxEUJTQrxIlJakwHCnyh8g4U0TVHZju7JUqDTn8BE2HhU1EOom8WiX3hhDubWzNRENLPTEbeKa/Dn9X4+A3AO0R6w5VUW61vZ0dCY4ZR4g=
  - secure: oKOD+zizkZlEYjDxxW4FjyfgnTfS3Xkf5K2iKq7CPQH/Z8OvmsmOyl1lZqIOYX3ao6SbsRtkqJMU12syuW4+w3eNg9+dkJs648PnqIHBSVnIdA9TShfDDkngzcTADVfy7RJTzc+tLmAPA+o4YHvU3BITOEllHkdn0kOH6bZB1hZYH94Jt3KvedTmHYUVl8wGPJRU991fYzrh1iuYgQEqKBiOsf9Q+fnTmQ1cPp45/RcVfcGbk+nNWjtAkFFlaUITZBk5BCdXYlwQ/I7PTrApc44c+UDi3FgiZSJ9xkjZ5wL7M99sdn/U+9GYVueJRlQmB5GIdGSDTx458/Q56hp6meVThZpDkKDHVYqJjGWcbpYM0fjEeRHhSdnWxtSmqETYpZ0/RN2woAVBEMXBuC3rwihw/LlFTX8NM+XtsyL3QjWHcHI4pbg7/EPzGEEmUnO4noXrieJKLmi2MqZoaPza5PisID8MnH4K4GucHjwd/DyD7YG3FaoR8tuVzZLxzz0O3ER7+eHceTDgMcnC65/C/6JzBfO2TpAMaZchKVlEJlnkbO8sjVFZrtJ0ylAnzRnwLzNC3XWVnFVgYRkOpfVYfj3MTYla8o21S5n4Pt0n9kwtWMatqgRr9iFqYmJ2aMSSkzqMSxjlHTptBWzTmKJXdNnNBdPmTN5Z0JeqLlYpxPU=
  - secure: 0m4CGGRz70BwaaX5kDetDQ64NeB+rPZ/zLCXp9LJL6AplmrQt4s5zbe/W3nkrRt5tXbvkFS65pb9HurV+NxfUtmPLViJPPthCAuZi4dI4x1snf9cWVFgO8aDce+p4VSuAkmLCttVrYFDmMFEVLbFjC2knLC8+t/yf448ybxJ2PSXEDwsAP6UmrU87SQyjT3Mr/3e/w0AxltRAlPiuKK0TmWe37UOVadfZu7Eix4OUFHLOUkfyOqqvN7s8g6z9iyNN60DmPG5YrioXGuqn6bZvunFHWMELUwmp1Ut7ftg2CEpyT/y9p1FPkTk/3Ge9is+mFMY7EYgOe4Npnda3OXLKtFrL41Ls5z9fkWTlUhrturjzw2Dd58lUIviZgXgg20U9B0iS6EJNWWvCLBwvuJbuvlaxEySq9mBsc9IIH9Gd1u7zPC402GCTf+gGCoKVLv4eafkYViLQVpKuZtg2IoGAYCyIUtjZfbZE7vLH1t8zLrv575CDKLbCtrGUnqIj3d2ZVHsOThEdBrl4OAIAtMz5u1GO4/dgn0MS9wTdou5ZImFHUVZn6p/F9pwr+aWmASkgYXme3pwsmRjcUxyi+LcY0QcZgKr7jkBVvKq43vIhvE270IZnJKZ2mejS+4joiUJedTW9jR1OqWfgFuMJEpzxtV3TUqnkbGOZNG6E22LDFY=
  - CURRENT_FLOODS_BRANCH_NAME=bds-deploy-boi
  - S3_BUCKET=ctxfloods-frontend-bds-deploy-boi
