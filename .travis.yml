language: node_js
node_js:
- node
addons:
  postgresql: 9.4
services:
  - postgresql

jobs:
  include:
    - stage: Test Backend Locally
      before_script: cd backend; yarn; yarn init-local-db; yarn local-drop-rebuild
      script: cd backend; yarn postgraphql-local & yarn test
    - stage: Test Frontend Locally
      script: cd frontend; yarn; yarn test
    - stage: Deploy Backend to AWS
      before_script: npm install -g serverless
      script: cd backend; yarn; ./travisDeploy.sh
    - stage: Test against backend AWS endpoint
      script: cd backend; yarn; yarn test-on-aws
    - stage: Deploy frontend to gh-pages
      script: cd frontend; yarn; yarn build
      deploy:
        provider: pages
        skip_cleanup: true
        github_token: $GITHUB_TOKEN # Set in travis-ci.org dashboard
        on:
          branch: gh-pages
