language: node_js
node_js:
- 8
addons:
  postgresql: 9.5
  apt:
    packages:
    - postgresql-9.5-postgis-2.3
services:
- postgresql
jobs:
  include:
  - stage: Test Backend Locally
    before_script: cd backend; yarn; yarn init-local-db; yarn local-drop-rebuild;
    script: cd backend; yarn postgraphql-local & yarn test
  - stage: Test Frontend Locally
    before_script: cd backend; yarn; yarn init-local-db; yarn local-drop-rebuild;
    script: cd backend; yarn postgraphql-local & cd ../frontend; yarn; yarn get-schema;
      yarn test
  - stage: Deploy Backend to AWS
    before_script:
    - if [ -z "$AWS_ACCESS_KEY_ID" ]; then echo "AWS Credentials not set. Skipping
      deployment."; travis_terminate 0; else npm install -g serverless@1.25.0; fi
    script: cd backend; yarn; yarn rebuild-and-deploy
  - stage: Test backend against AWS endpoint
    before_script:
    - if [ -z "$AWS_ACCESS_KEY_ID" ]; then echo "AWS Credentials not set. Skipping
      tests."; travis_terminate 0; else npm install -g serverless@1.25.0; fi
    script: cd backend; yarn; yarn test-on-aws
    after_script: cd backend; yarn; yarn rebuild-and-deploy-with-tons-of-crossings
  - stage: Deploy frontend to s3
    before_script:
    - if [ -z "$AWS_ACCESS_KEY_ID" ]; then echo "AWS Credentials not set. Skipping
      deployment."; travis_terminate 0; fi
    script: cd frontend; yarn; yarn build
    deploy:
      provider: s3
      access_key_id: "$AWS_ACCESS_KEY_ID"
      secret_access_key: "$AWS_SECRET_ACCESS_KEY"
      bucket: "$S3_BUCKET"
      skip_cleanup: true
      local_dir: build
      acl: public_read
      on:
        all_branches: true
env:
  global:
  - secure: Icc/Fo8bUX+y+E2/dAun8M2oV8hqLU7QZEhJwdkrpsiOJ+z8cH7WjpDUVUHJis6aPH5sN30wmlg5CbM6wbzvBeZ2dv4frAeaSY015f1OiPXrgy7s3By3t8ZVkxxDMwX9pXcPK/+obhRLZ/yO4Rw+TreU5pe3J0mh68AYWlEZzlgcdhTFvFyo44uV3ze43xuUJep2ec2YDTnZmQcL16+sk1BLsUDPc0rfQzgJRaOC6Kpex84jhaeWAJf2IUfZvlBsyJ+KoKcSeHBMGWdM4CafdII1krroINk1xobir/8pU0YSUPHDHq5EOs9BM6bL4IlEJUA3PcIWcBgpfMQ4MsAhqhySx1TuouoJpzuvUJiDnTZqQVtMlFLm8qMqhCKEnCqKmmXq/U6Zw2YJMJ0A97BUT/mGv6xluZlKnpNpxVuGuSKHGLJggjQLE5k2cC7B59qQJXV+QnWI7l5a9yXAOJvIPaDYHlAHuah6OQLQ83ljVCsjsv0qWN4GmF8P4HCvvTUSQDMSEVWNyv2BmvFHHBV8kI0FpIX2yFt+W463kc146IcTWGKULPNiTasNL7I/OEnQ2oMcE8AKUMgOHnwJO+YD10dQ8wsh6QEdwrIKpGxw+8htwGH+PKbPy+dHiJjp/DetdMuQHOI+rjt/81OABHHlnM9eKAHP2JFd261KVHSYZig=
  - secure: ep0AFNmqgo0oWbQgv64IVTSxtabH7UJ+AkbuCjYgi5itDYM4S5vwaBUakEEMgiaZJHIY/p8Cd0Ivc1vdvkWW5A5EUaRK1mXAh2EYb4TvwXKLixFAxEBi/XCGPErfzrat907dI/in0aUU5c3Kc20RtDK4QxhTTHqzvfr47ZgMT/kzAOtJEiD52e8ZHXTDFD0ccUMSJmDDBi9An6R0KkfJAtQJ+kAgMoiJHw7nNnprq/qdi2TiQR03xuAEvnfW1TOK/CiBGZzPISbg4WSTeQGt9H4nb+s/ED5T5fVueDRytHCp8BC9KcWI9TqBu8q6sHLRtca+wmsOprWjf8fFPC4zLl2XlmNFrviOWY3C8ljN6t9Q2U+DNlKBy38rFnGJG6fdJ2Zo/LWsF6KOmIiAaqK9e3xx8C797uqdkoe3QG0ZnVmUB+dZQRbMmzcp9nwLRVskBAEUmfJefvKuINgQQu+0Hdf1DM25CLnY7bJRy5IBfSPUNyozPBWWPwo9uY0y0D26npDR2NaPCUnQpb2Gcb00k8v0KJ7w6apUkOeMJKDrtKVqAaw8aaF7Za9oxi3ikgflF+pqYgZHaG24ehubCgovIFfnIY0cc49HGK4qS09ibAMNRnvnMhO1yUpI9zStRcyP0fmCYSrPJhAiIg3hAa7km8ruEzD3RrjLdDcFy1ArkoQ=
  - secure: isEehfudXHTPMnx+U7h/ffjDTsdSyfl2hD4DyXNeoM9BcHTRhw2TJ2k5pJL8u8RkXuNeRchjqMZZFPwqjzewmVg63duN3BORodTgorgRMxy4rbUfOsH1YJqKuC+GbFVkED/0GCV4kmp/r/rcrrX3RRdCiqEZ/IZPBaS84ZoR4M0Wfx3IwoPUAb8n2+UZTSY5sv9GwPs+ZCGOT2MmwruqK4ZG0YdLxT3Cwj3pW3ZRiQuleEUP+/hp8GmNQaKww0gll/G+BtXwDNO4nfe62vasWm7MdocJgdt+g05VJq3W68UiEcRifFJNORBw3dCXzaWC/CvGnxolezySwLXwnkim2MVir2L/nGl5BMur7qFuTJULD0YZ8E8jf5s1W2aOiNSBD4iYAxVSGWKBSWlN+jLpfa5DrDILKU4UQKdA3qo1lDLTkrnNQB+smJWZzRAn55xnSf2LgSvvID0kmirSIPpQe9D/TVL6utxab2bdWaSAJwPTww+X90nNQKg5GBDzk4E/3w4yNMNStuegaRDf+FPXyUCbdwz5Hf039dLAkP/XuTUcCyY/1/CGKvHha6HblHY0lC9xTD4Ws2717NARJIUWlmquAOL3JYAR2BdAm4O/SDj2llGb2btRg5GrmhkCUF+RN/4qGxn2STA6tK2Bc6GaxYAPPcqv7kxMKcXXXYh/W9I=
  - secure: YP2cGNPhUM4gGz7Db9MTSK4urFh+ClEUB4b7WX6SrWk1i+5OENTDZRhDR7Q1kLKYeoZ7kdy1jelZ+AkoilLafqFnrJyIb5Zg3wz3IgDSIVIXaYVrGgEBHvthwEkSaZ7upbQuu+WOEbWAuEU/VPensSrvn2BEeAxHpvCl6df+U4ksbJZ/hEkssNiH+hFwOQqsGGrmJS13FJraXDujXvaiaqvAiFcl0Vfqh7S+8tgNI9ikkGPSGF+sZmYKfYRD/83EWrIkdPP9kBXHO2G7FT6WM4Jg/cOBgvOl6EkGbCUdYc0YTl+Jc99NVzdu3gP5l8acysVIxj89+pZVyfQkiUs+7XOIX6gmNLuebapKpAU5f+p/Qbw8NPN1mh5NEm7q6wkbgBjB23v9qYA0YnWBmAN+H1oWJjlNyDxZUMw9XpR7N8qYVCOGgMiHxvYQkKv0pk+Qq30ZM6iS/XbbHFEEldhD7ijIlmtolGnCxMpCfsKpWfXs5/wNZoEHJMY8DYrFHqf80SztLDe3/La1IvhcVD8dvmEjnjFpXhGYj/mqTX+LxyhHgFe47SXnmZwooBgI1ydDvSwEVytKEfU/bGv1v/sx3MhzCi3BAH6oQ/TB+K7qbsTKPGReH8qBdnZ/tw3SqXUEdbwtv1HtemOxtDSWJRisLpt6QfA2+vvVDMnd1nc1EqE=
  - secure: kZ8IjtK+7N+PT+xq8lXL5G+xoqQ1SDokBUFEujaZxsYXmxfL7Sc61J0AjwWTGDEAHrq/z5GHKhtwdWiUGIlswWfPdLfvnL0MsDbVFyxGdywoK7MxY7cu3RDlEA5duvFEfVk+G6SAW+XmyQ7bZyQFfT14QvVpPIIMWzKBraIOE4hJZ0T8D0otJqletNdjR3KsLx+8U3KfXN5J/7/8WzYNhMrwJMXEDWuEqgk7rUTf0CliDIjTK8o9j4h8pGgqL0PUGpGIwIwyCnE04yaw2ocDPZ4U0T1ItFggsr8+gsU7ZmmS2XbiQiuYyRG4nZ3XSkT47swgBCLryuZGdxQN/SIW5dSx+Yqnltrx6rVwq+jfUuce/Tx2YD7R4z41a4WwjlUl+lPwnHjc+kXTM3jyTgExNnnfB45v4b/oitXriWog4LNv0oEPJK6fpw1Z8b9YOfocjM5NulADsKc557o/P4EzekQQeUwnSk9+rKhCZ8z6X24RHh6Syp1V5Qlyugaopcf3IOuGX03mYByYK9Y1f1uPZNoKOokuo3kDTXptxF6+wetaDPTcYJZRd1NKhvbGUJqYgoPN+qNumAtW0GqUI/HH4JCALDWkZDh4prXLmJOGDmYIxkmS36hht2//2JZwaF7dDNzNuOxAqbFmm73bkP0rrS5FEjleSq19jLZVyy+38oI=
  - secure: v3Vwv6bF87li0mXeup0MIikDORUsLb5b/SokflGDhugH8RCNuuEHXqiQLSExQjEPFmz7+HSfd15mOf+7UpqOBjxsJZbYJwFtP414/RjBXfNcmWKvGu6jADNg9GhH0hix57aLPmC733WTANpb4rc8RVpLErF7F3lnCrB+ffEqggsjJmLO1/f/yXizTuyYkZEHOC5/A25LqUvCop/0FzMUXuCGCPQpI57rdIZ62KwrzQBBDIou+soSfxbMzoD31u1CtxPxbZP8JN2kn86NdFuBhBLe4pGpHHsgofgtqoqGJi6vec2jLMeBKzJ3QDoQq6eDZjZpVlWywqWQMOs134lUMWTfjNn/bMsdV0hIyrVIARq87aTw1FNRVgPEmXbd/r2uOMKv8/TDjTIUa2gSHxUF2iCGiTibiPsq6MH7ejicTt5lCWUEt/bz/1uODvsMfuLjmPhpoWxeYhG7Og1hEm4FfEo6krnGylwmRp2yTUQ6TByzI0sSnOG0cRNTANhVcqOsRf75dUPiNovCzii6NELNcOKfgVzlIRMESlYB3e5IRQXHa4TXTPvjqoFJPRBQfsPYg8YVv15aUR+ZJ4SlvsSHJM4i9gKCYJ2TD4jFsLv29yr3NwfMbRm27eQHBBXbFo0BmBQZ3OnX7vMOtPK9m2me8B3ANlWBFLG1Xpjsvo8zNuI=
  - CURRENT_FLOODS_BRANCH_NAME=bds-deploy-boi
  - S3_BUCKET=ctxfloods-frontend-bds-deploy-boi
