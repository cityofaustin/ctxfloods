language: node_js
node_js:
- node
addons:
  postgresql: 9.4
services:
- postgresql
jobs:
  include:
  - stage: Test Backend Locally
    before_script: cd backend; yarn; yarn init-local-db; yarn local-drop-rebuild
    script: cd backend; yarn postgraphql-local & yarn test
  - stage: Test Frontend Locally
    before_script: cd backend; yarn; yarn init-local-db; yarn local-drop-rebuild;
    script: cd backend; yarn postgraphql-local & cd ../frontend; yarn; yarn get-schema;
      yarn test
  - stage: Deploy Backend to AWS
    before_script: npm install -g serverless
    script: cd backend; yarn; yarn rebuild-and-deploy
  - stage: Test backend against AWS endpoint
    before_script: npm install -g serverless
    script: cd backend; yarn; yarn test-on-aws
    after_script: cd backend; yarn; yarn rebuild-and-deploy
  - stage: Deploy frontend to s3
    script: cd frontend; yarn; yarn build
    deploy:
      provider: s3
      access_key_id: "$AWS_ACCESS_KEY_ID"
      secret_access_key: "$AWS_SECRET_ACCESS_KEY"
      bucket: "$AWS_S3_BUCKET"
      skip_cleanup: true
      local_dir: build
      acl: public_read
env:
  global:
  - secure: yjzKIKcwtdbYeeLLkJYSNqCUPd2F1vzJ/sF+gLMVe0PB0gWW2x4mSk0mrxfRzgTjwuwKFiMrKz4dtdrRGvBKikXll05+b6fOII/hs6xJSXUqnZy3/Zz4rKad2dBKFgsE8QwMWWNizVRL/x/95eN30zF4kqfKoGheYc+MwSeKaG8ec0kipvLGx5S4lrrdsXBjy+0c7LBw7TNLXXSPYLnKSr4mQZW3pkXTbUS74RmGhbE+6Iv1zoa9J8jMVTNGoA9wnTUj9zs5yZ4Z9sjc8o0koxts/Blmq0PkoqnEksdbDvjKAKgfK2rrqzX8hqx1SY9o/ur/lOj2IlHDB2GDoPq9TCEIjUDQ/35rRzqYVlUtt1F30kWV49TSgbv2k/ppd0VzN7Uv6BnPMECqXlNtLfw/OYH8PhCU3kbgvp5JX9V5aWRjaZ+mQcfvA3g+sMDSSppD1E7dMRo0v9fX7X1iWl5FT23OZUq0mC6+InzmakxtI/7kJ8xkHjlZW2MSiodn9UTdF5mrwfdKC/+AhfNRWB+OjeZ4Gtrgj2JTVp0GBsJPUAbWoxGODGzy5eigiuJ8pT4B5tD5mMXB1NyKEHXt+Nd+N4WyfrcSLePw6lvGQRhlikopIulIDiAd9EeojaY1T6hwfAwxbDIpzoO45JLtW5yJtgoFUKReA8t3MRIztdD+l5M=
  - secure: yPD6Xlqm+hK/vNACHCJVMowp8JBVmSF8cfFXQ/lGVLW/QYbgST4lrq/zsL5KcngMoBSpbYFkpPf7KdfMmIxMN6x+qd+7SzIOasvSiB7aEedH6D4hUfK0GQ/qe3SKocJ7cFdRx+5TNXqzQBNuzLD++ZM10kAwJOs926A+RFtxkgolmjb74QYfBLCIT5rXTCM+36wnQDzU7nriPXKCOglPPq77Nq/j3OIbPfG9drQIPFSADRtPsyNDcgu6Z1zAp4Z7wcZ2M1pH8iBzzqpuE8ffYIH1CPICjMVLZUbVwom0Fihpme97ZvUiFh3MbM/eRfAVJxKVRkfo+bbYqbuz/kmq7SKYq3acFf+rE8/CvtZWIXm43d7O2Vn2Hx8lB5a0lCgQ9sXfCTWxVpNqvrY+0K+1GeD9jKCPoLxFmZu+by6R6Xg5i57gcODpA/oK9J26EXhSJQ0XGiL766jXnvznLaE3f575jrVEiOHBGMTF4mBZQw8+vi7R6e27mr1DmcMoz5Umv4v0CUwh6+3lnucNPIkm153LqMadcl8+inhVWThFRw6NEoCqTOU8RR+pk6c3CYIzy232qhBLGYALcgWTDuSv0BugXo56i3vbsUCdj4GuwC/enWv+066vZcM+x+aADDgttkCifHLqw38P4urVZr6HVKR+UHhONuopvQ/N4V5KynE=
  - secure: B1lBPC6+HAdScyAe3fESe63CipF43irFco42+0uN3cHYwlY0bTM3ALESbbn00kEoJeoDch4pmBJvtqN5nbbf4CgcDyRDjMwb1PJf/bgtFCxPuIeNCpCHwPcFNs6gWX+i0Cm1eydGpRUKbJs4pJy7MJtByBZb39jufm53npQdGX5UhI+gHfsjdv/2cubNdWO5FwAws8IH7n/o4q3W7SijGHmxxpiOe1CLuwnj6H6rd+5x/99cWEaes6jf8oo2lrVCNaUJDGYwNHatA2J5g82Nonk+p46lqaqekQln9sgMEnTqH5dzIWKaS6v3OyORob/FxRVZrpUJxFvH9SmHnd0CLLGCoX+bko2Sk3LZ6ibG3qruFWJnWNFZkkSwOQcrrr9aOVD1NtILBLFuvyLDlnldJVqrQSSApcbSw6uxaxugM33e1/tFFdp11de93EYir6Dh6g45iz+8NqoGC4dd2X5y3fUESUWpTI5oJLvHgpjenI26cq2zKa50Y8ED8EQ8CsnTmF6iMgsoYqZYjPPBAfe5TeTi6s+bppSQD/TLDFGUIWOqLJ2ANhpj2iSAW+1UB2kPdwkdHc79KTmVUvTwVkTPVs7bADZkQdRUzdHFhEI2RehZSL2xlPOI8RklZ+/Tz2hMMZNKzylf2sew0pGdmd2+Kwg6GD9yY/NHWP/Tu5QK9Ts=
  - secure: P4HXop9ey+akoJTGmpBjNbk6Nlka8bUeCJdkoX6lG9B/84yd0AKJj2jvIgPY5h/NHbAOLq8riuiIOF+rnanmCcSk3nv9/ISqR5q0qwavNBNMAM9TPwhsHo56AqywzkLSVYRzL7vk5thmx9DpJn9aT2drC0Tf23b4j0bG4invS7POP+1jO8oA/fMIhlm4qW0FG9Z6vU7YdgFkBhiw/cCJ5kdSX08VD9s+9ZG8uCeKaI/ocG0Q64G+Ct8GBVM/xDGd4/8WPqlH6fa9jGaKCnxxQH0L8mWjKzdH2P1y+HvldOjtktHp8FYtpKV/l9ux3NJXBt8grnG0ZbvDrCMR0LHw/rgxTv5iEgzb5nCxVc8rSBo8W74NH7c9eK4IxIIP0Ch6kPHbO8AonSOemf0dkzBskIPHomUdkOY08daZLV6NIB32aXHHgzyu+g1x/lW4njca5u7M3btJT+NLoLuPfnfsjtDlffrA5Ac8hfNsXNvpFtgYfEoNYnMPFY+WOsed/aZYD/AYSLeRxuPg/Q4XdHUxfc9bcrayxo4A/IlDqUPbkf38N99p7C1uFTUHygQxvMJ1B2mcXohaqJ+C5RDVZWsKkWZwfxeePBsCcFliLKiQQx4A3n8LXzLUfdCUoZjhkRYhVcD9Jmk7ElEqbGbkoah4IiVOFNJfDcROtY6jPDT7zvs=
