language: node_js
node_js:
- node
addons:
  postgresql: 9.4
services:
- postgresql
jobs:
  include:
  - stage: Test Backend Locally
    before_script: cd backend; yarn; yarn init-local-db; yarn local-drop-rebuild
    script: cd backend; yarn postgraphql-local & yarn test
  - stage: Test Frontend Locally
    before_script: cd backend; yarn; yarn init-local-db; yarn local-drop-rebuild;
    script: cd backend; yarn postgraphql-local & cd ../frontend; yarn; yarn get-schema;
      yarn test
  - stage: Deploy Backend to AWS
    before_script: npm install -g serverless
    script: cd backend; yarn; yarn rebuild-and-deploy
  - stage: Test backend against AWS endpoint
    before_script: npm install -g serverless
    script: cd backend; yarn; yarn test-on-aws
    after_script: cd backend; yarn; yarn rebuild-and-deploy
  - stage: Deploy frontend to s3
    script: cd frontend; yarn; yarn build
    deploy:
      provider: s3
      access_key_id: "$AWS_ACCESS_KEY_ID"
      secret_access_key: "$AWS_SECRET_ACCESS_KEY"
      bucket: "$S3_BUCKET"
      skip_cleanup: true
      local_dir: build
      acl: public_read
      on:
        all_branches: true
env:
  global:
  - secure: cIfH882Ix61b4SoWfrAMJXXPbTJ9XxwZuicvpWKORRqZvPQq45H5KfS5oonM4adThxT3N+x9SLefra7eyJcH8xLZ+kZ+pu+7ZUu6eYe3d/kEiQ1suvWEhX8kbZ0qsGfQBtVuSXrBIQej8esoOILqSYXV2Av9bET14pTFPKdxQhiJ+LNwIUWxaHssZw1Jshm/tyI48dMiA/tvsimqseKo9xr9Pff7O7UcDflXMZhWAFRjjrpFCYtuM/6eTo8Km9IdA7MI2baH8M5NGg0p2uCYLw87ThV09IEHiY8vxMgLNbQsuY14311xsLz38CEMVk9KnA5e+TQdq3FTMUVjp3WIfJ6BEB7Vn5PX6Fkw7hBfx721nxEY2xaVmjz5+8tECxWs3//4COBYMDD+S2lSjbwfkNxNhxGjZA/fLH18Y12sT01U+ClQOGGW48OmegGUjRURInTTm/ZYVDilC4e50tX8ptELgoVRKRGQ2/n0XNJRnyApjNRKSrLv/sXBlsVLmXugCnfco2EyclcY9bPJHA7cJXjkIBfZqX1cUGsIZ9J12mL3yzW4xmztqCf8GdJ1VGIK5VWd2rf1jhOP0vnrLo2UAZ3kGUb8vGQOZMUbseqZYxWSeyKE+/ZfBSTia3Gs1+f3te9UXl43ST/KC90Bv+dwvGD/d8QPrciwGczHKVotAI4=
  - secure: 0nCqd0iHPqCY95Mha91uS45lFXWNK0uJmk6PsJ1MYQrHlbaxAtznTxxEkXggJeoJO/PL7GP2r0v1ZZlBVDT1N+ziP0gPMqp6CmPvnSaNVOrG7loH689dvlyLZ6pvtvhAVkza18KHxhSYX3+8JvUHQm7uzSVXQv+0+shPnIaQMyMx/YtwWvyDY+uWH/5Nr4GLrz1az0SMyFGtFjpEr2imj1QN/jH/Qe7jtRlVWrL//TFTiDJxFqFS4We16vKxyFKrX5Mzfejbc4KwrEjsMvCT4n2B43hhTm5xdVtNrsPq1o1Nwe7d3LC16O5TqEzj7dbyLMp7NEih2V1CS/gOQY9C2SxVXtRGuradbjtaaVBTQFu7yp4aochAYdotR/mhXMFVbiyW+cP7n7xJcZIdhQ49KM/pw5PA0jKa5dJzeqtogWulzPhsgA2uCDl5C4Wf6c5ABohwps3kEp8n3vZ05/tzKei+fn9qN31a+HoaTdJHFB3L28tqhRwczwslYT4+Cndk9S/evtKoGvJXAigqtODuWRXzhj5k+TeNJuDxaMA+ADgVxOKIee4afVg+xFo7YkGImyrw59EJ6fAH+bPY8zYmMbzVckVj/4a5QBK8e1R+vQ3G9XNpAwJx9wut/UWma7jp8eySzZOrcW8udek2mlQwPyG90zZNKo9bHcMLbU3LcyQ=
  - secure: Y9NR/t2oV2UB+rcJuvtl1k46IYcKcsV9pC3bOEIFpoXud45Aikj7XEq9iZHs28G1mqsxmN1OkfaMUDoPIp3tbu5WwRXIVnwNbNy0CQRyXS+6Wb7aABeokvgiCbp6lt/jByGRh0AXhrD5G3ydxeQU7NJENBmeBBgLKxvRfqIgS7b8ziPh8YJuQGyMKTHfN+lUrWPXrUYdweP/CwOBWPcRFK7MUBZnnBXyvnqeITg0FHDYV23Vun1VEQlECeVC485SI0l+EgTT+jHXiWzoiy0PZjn6xZ0P2ag/8IZ4Nce1IoFmLW1u6rks2kyoZG0xi0r15orszzgUrD4W11VwY2neDYJ/6W2UVFL8QyORLJOCC0Kq3a/NzDOLfnV5pAhttiMeWCDw7Ym/6z84o4ayRvx+iDGHT6No6mT2AlB5vSxyIYSyKP/0CKqCMbOa3gfSPDJkTZZfwXvzmAASkmbIr5mMFm+HGRMvUULXUz6xMhSlw1w18E1CWYb4uCuBjjFmJykeHnk20L29+2weQCBIfp6BVq53X3ApnRb14EpHhBKv5p1H0PUIqNp5/UDSCo2zNgNAIOFEFBtR8LGSPf1G3kT7KuQ3oTYT+MrDV3M6vcyXTx4x41TA0TwZ+XPSKMC+/d8tIRcMk/PTDvm0VofNjq+45BhmwX5SMoLVN3CbqnIebOs=
  - secure: jHkf7lJugIJd+Ia7ilOi0WtTDv4y8TXr62AkH0Nnig+nqUizKr/OSQU3shkfvrytLzDMS+4Vr2hr+PWH3SvtaTYsu9nNjpYMaRr5Z/gKRDgEnnjyPKIJZZ4zYer1t8mcNj3gbjJphXSAO2pJf1J9MuueGK7nLZtue+7aTItJEHrGQvfTeUe35IhUy89Tm9J84bqpaKecSjWzR/JYioP59saNB9xj9nw34ugtT4oup0OONEEsERwX4mMRYzewLx/oBlKY9M6Ldsnqqf7bPlw+PY2CHTnofrpZ8+dpm9XC25Kbnqp78sHwiBBUTz2dt8uf+j72aksVy1m5BlGO+KIu5k8d9cDEACSM5O2+XPOqZyOf1wnD61/iXvHMvSQb/V2CdIcheLyK8ZU7jMv/3jIjj1KtYxHkzb5Ol97DLn6zICCRT+YJDBGRrltfOGGeIJuTVq1CQCUTsxMmEg/CQbQKOkpS0ERiiJmROYnbrlRIM2YNLiqKOKYTCTeRLxWchP16BciZBCS78WOCtJwtzR5TCGqXxSxfkuR4RJlAoh3vxTH2L1JhlbiTyxvprCALsFdd9IqUzjLsYXjtnLug1U50S/04768K444+7QG4KcKBMBIuogNo+C1vLDFV5fEGVNA888MbADDHOH51kPyLXK3RqdaesQATt8i6DNdYkPxVJ8k=
  - secure: Dnqm22BQ1xDV0iWWN02/qPCyBwbDHwpk94hTpYAP+42tHSc8Vnsv1o8+aaDg0kcZaq9iZCMxrl/8Hz9qwqhCjuCzi6dqC15afbJbo/kOHPoMfHC3U2ejIaer3IEdinFSBoZ44CNys9kmBawqx5gmMtKJr207nuFl+JFW7OR6dQ/bDPvw6dmrRXChTQZYsZnfS09F7m6MMpXkSC8bBJ5pxMeanubvAHtet7qo7FDon37d9NjRuUsouOki5SLyq1rhl7vLTL9iVk2BGjlsJ7x6Qiwv1RTJIF3mXO9cB68lUuXGzSdrpA8I+UDkATsiyhVtjJ3A+se8+eLWRj65VYJRzxj2eSPQkk8vS15iwG7B0HD3iZG0goeUrjE+qvw9ju7yt4Hw83/FrU99Ml+eYcKn2Q5FhgJwR8IespZAl0BoYo2KuilcUzQuN+6nPSX6Cg/Jd34iMbfz5cjJRQjkU93tpfTDOoWCAxuwlearBlzb3moy8VKwQBeY3VgzbSb4MxhuezN0QYFTFWBVaYd5jmrJNi5P2cZiIIF7FjXUMkVz0qR9OCZ3o5UVQbUkuY7nIvYb84CqbvFOed+d90aIqfr7pB646N1j///ph7MxR4xhVPYYNip8xt2NUwYEjmgCufXj9LX9pdzDyaUZic8YQNdzZRlceGN11rEXBkI+EEGHJ7k=
  - secure: JE32c+YkxyOZz2t+JpZYK/gdGc/ReC0M3ULXuJUrkXykaBD+qmEfxBb7ojKWCcd3+nGKf6ceWME1Cig+tN2Rda1MiIlJT6YXRZa+cxqiV2puFx2g0M9lR6dFZeZ0w5LFtF4mdr4WyKtG4G1k+VSKD/qsdQCdBjcT2AyrZAQqUHJrjI9sO9Aa1jRO0zJuYVL7dOU5vgJfCCCn5Ddaw0SScTlNU+fqPOJTLUOOs+Ksjq6Q9zubfHcIGO2YqAyxnsywlc+uDqhNvERdP+bLCV0YydeGncBm0A6bTeOgrreIGA4HzEXM5oakjZHECcTfslB0EpkD1qKCSDQWy137Me9RYPC+5HwNa6c8WfdZuyGrzs2svnoG8QmPMZMl189beVPKkHIuzrDxtwlGD6UWGf34uFWdm6JnbGPJ7nAiJepBksRzMJHphswHZ/L8UxvcQ5P1ORpljSJn4xF5/knEg0RXZlvzx9pACizbdKJnT44/BHFmbpcxwuKkhMWZVdW2V20vjj6kEI2idl5xl6PgukSmByhfhqz+tzIKq8rnuIvjcHIFL979PAGVK+s0boyKGBiiQER3TmwEGONZzg6//istUIhDasT6iAWIv1xNHmq9VzUJ675zn25/BNerpAbyuEafq2BQRLQI62oyZa8VusnClWt6nmZFO/gSZ4L/ap5SnsQ=
  - CURRENT_FLOODS_BRANCH_NAME=betterTravis
  - S3_BUCKET=ctxfloods-frontend-bettertravis
