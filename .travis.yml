language: node_js
node_js:
- 8
addons:
  postgresql: 9.5
  apt:
    packages:
    - postgresql-9.5-postgis-2.3
services:
- postgresql
jobs:
  include:
  - stage: Test Backend Locally
    before_script: cd backend; yarn; yarn init-local-db; yarn local-drop-rebuild;
    script: cd backend; yarn postgraphql-local & yarn test
  - stage: Test Frontend Locally
    before_script: cd backend; yarn; yarn init-local-db; yarn local-drop-rebuild;
    script: cd backend; yarn postgraphql-local & cd ../frontend; yarn; yarn get-schema;
      yarn test
  - stage: Deploy Backend to AWS
    before_script:
    - if [ -z "$AWS_ACCESS_KEY_ID" ]; then echo "AWS Credentials not set. Skipping
      deployment."; travis_terminate 0; else npm install -g serverless@1.25.0; fi
    script: cd backend; yarn; yarn rebuild-and-deploy
  - stage: Test backend against AWS endpoint
    before_script:
    - if [ -z "$AWS_ACCESS_KEY_ID" ]; then echo "AWS Credentials not set. Skipping
      tests."; travis_terminate 0; else npm install -g serverless@1.25.0; fi
    script: cd backend; yarn; yarn test-on-aws
    after_script: cd backend; yarn; yarn rebuild-and-deploy-with-tons-of-crossings
  - stage: Deploy frontend to s3
    before_script:
    - if [ -z "$AWS_ACCESS_KEY_ID" ]; then echo "AWS Credentials not set. Skipping
      deployment."; travis_terminate 0; fi
    script: cd frontend; yarn; yarn build
    deploy:
      provider: s3
      access_key_id: "$AWS_ACCESS_KEY_ID"
      secret_access_key: "$AWS_SECRET_ACCESS_KEY"
      bucket: "$S3_BUCKET"
      skip_cleanup: true
      local_dir: build
      acl: public_read
      on:
        all_branches: true
env:
  global:
  - secure: qJELdps81UF5qFdhY/NDomq0TD/ZkfjKwjAPT/jA1rd4AOET+2rI5+XMUEV2b3lI9f5ErZaf38Ej34laDJIuTx5tUR8gT+1AigPLJ3bsaCZ6A6+TUpXnp89EhF+jRQ1cpotNa5Et2/ZX0mygGrreDmGQrlJMuG/2MMH6n0ODenBer6WxWr9w5bNQ7tfxZCa9jRsD3Oneu+Nz1rCVhmEx/0idYBjkm/AF5NuF92nqrOatlwVioANudtweAg+GfyeJBcsAPno8h1H+NLfUYgPaOAVXex42q45NmrV9ao11ba11X7EStM1tTh1cYwaEN06o49/+AtxR5yU+JgyN9vh9Cse/C9I1wro58T1pkZ4c1In5eMC5FrHFQHr2aGAGylPsLtLo581JyvNXs05vCos/bnI8rTbh1oKTeeqchNwfzwkBxf3pMmR5Em7BPvkjvLlyTTt2xVZlIzFxZqahK9YxRxpUP7U7OCW8m/VsH/47+2PT0yDekz0qUMfolIwsiXTNIm+aSXaoNnuqbiNPeqqoCb0oe4klun5L2xSU3hpyAd564wsgpDr3YuirglQz7nQ+eJSH+z3Lw6MmM4vyuJaO6XP2RjgTikxqliBARszH6s8r3jPqr2Culx+n2MwH8yNdEiLDv4EnYlojRdiChWVigYqXXTd8sc3aH5sQ5TeW7hM=
  - secure: ec+ge4qo+ThB6Xjpdp9ZfpVcx1Jbp+wC/KrXdAY+3OxEG27cBal8iK6X5IZL2VTdI4LeqUDDaIPRPZHEqNF5ebd50iHjvQEHx32IPezSJhxP1McAJP8tPlccbMSvsfoOIM2NdUtYddG+I4mRZECATfLdSYoK0K7EqsqJRildZl+DIK27cqynIoTnuurRS+4Affjf6BgIb1u2nPQbQ1weKp1Sv+YWaE8iI2N3rVKAV3jNIwo/fT4by6a7U16K+Qv7clUpypWkBzLWjS054aV7NnjLImiX7PxuGEQyYfl55+VxX4XHvS9RZ/YGzFJP8CFhCOrBVOWB9pS+NCkhTyjQki5EX8+Slfu36Y0Ddme0a9R9RXS01+/pukdjpPtcCTIdLXIGUZ54GvuYPu5nTTmqUpSfN7iILIaQrwlNEQIGQTTMSew0xEXKxZcAoUyugNjYeFGfqgBeG7SdFZGPT8j91wgpQ4fglp48enrUeLgtnXw/KsCQUm3+1DPzVIM5qT4Rrd01oX3VN6oPNKGjxVSSSLOJjn42c1WYqoZinvrLGiK15sTfWVivIKEJh3LO64yQq5/gU5S1VLmdLuF6pKWiLJdbdj+EpZSxkhZtFgOAM/ddzzkASVjyn0iww2ukPbF1nc/PxxLWt1J3GGAnk9HDv4lwvn2/o2maj2dw9feSYtE=
  - secure: NVtT0KhGH6L958SS0h19QX9f+0Re4Go/GwNK4SDZ4TR4LrPCirySEuezwkjRD1XI2sfG24um/vWOqXxvk72/gzsd1Hp/ynkxovBR7iJjeRROzDI2x/teOB8Q11WWp0D/pt3eFg54TTHw4tlGMOjb7G1lLSoN3PfMhaMEihx5fCAVOrudTrr06WiOvkmG3hgde0fC4mhBA4llVpJDH4AYVhG2CfBgath4Y+KXvJZuxp+ehoYu75JFMECfogD52eTgIRLc9udWMD2iOW4o3JiT631qwkM8jkbHKCUWYWwMB2c7n8FJ0GVQG7j54y0u2VfWD2hRsiHx8V0zq3qBwWbjlvqV+HFgjpFpeddb+e9wUv6YZjCB1FkbWNawvXiZ6RwtEPjLs0eKnBaBuxeztoDO996y56bdIlt2RTksBvwZC7kbGn/zc6UerFJwRVM03uNMI3FIKBNydG5c58ZYTLgqXu0VAKCA2grQrAQln6M3sNCoEeNtuM44OuyoeCXk29KeRx+GfUTz9IdjtwsHNs7/26y4b/S7dRa3BEHCxocuhG3KqToYFYUlmGBaYo8c1Wk2i5rszs0jd31tOldIbiK3RSYQCYYZeH1awixQBCYJlkeHqocPXEHaerq6qq7D92CpAa5JbLn6KQxfgPyNkPR5J6iyigiKMov077ryXfTp5L4=
  - secure: Eq+MPO7uqINcRhcCdNvndB2GU2nZqJW8b7fGTnxe+EHoOjpgry9OtxP/SAG/slB5kMwGk9zfDyYftogMr6zgoUnUpP7JVKpJXPGFBAmAkG4NcqoX/FO83TAVxB+6T4j7fXBs3gxXoX0wMCv1Gq8mzVF//qZxkvesgZKv5KY0MCF3dHeuRVmHmKw4Nt88je82yyNINBRDZ+1SWfCpFUCGh9Jor8QHtICs0NL8nXQjLVmXndlWxpsmPEB3Na6cMwuZO17i3ZHWs3xeDphhPlqY5QuyxgdDzgjajfWG/RBqS6tiGfLRCw22d80eMQE+u73O5rXrK0tAX3O/20daJFC8SIZXH3iDyJZNBSm6v+uL93V/rFl+7r/+/R71sgndENqP+m7IFdrdDSdQxvdd7ngNBXkGv1pJeLM9yNc8OuIk7fGkcK4uuXMTTONAtCUGJFCcKfz92lPxF5Ft5n4UYHN0KsWRLt6rAPOj90/t0pG9R8KTh+qbwerF6WsOYTOQolux2uO5UZmip788eYoMxZSoR69gvyaoGlmpeNOZh3lYiNgsvKQ4Kl63PDRIqrLkoCY06UtsIs7lkZFOzAttDwXQkMasSUgXLI3IQGzyFtZu2goNLX+LMgVizCZvRMN9qmNUenmsiGHOXMdmPaOVbZQpAhoPPpcMyZ+ExM7pE/ZawcY=
  - secure: wBlBiHoZB7QNO1rJa7Bq89fQhdqS3OTkJIqfIBQ7mZjOoJNvyJTWpiEiWdBdPvUnhBjOJPGH2QcZ3v9dARb/fQ/pc7BuvXZUDQyweqkaMB1XmTs8L3LdGFrwiPWknUMnnQLwX7GxG0T8w93RnBgu2QhX46RFDtcCVSh3iwq3r0PhRaY/in3eEgGMXKgdsV1UmmYRqovDu37YLNz/2nC4KXxkBvrWHiqDFQI1xssSl/j5HqPZiJGlHum0YcBA5Vm9XrS15SFXsHZkTVLJIIoikdddwDYGZbrqMGkMBzY62gSGMcR525eVux+L1NB2V7bZ1teKQnc880XSxAZq4EQzeTKqkGo4a+eCOMi5ErI4R8SGZcdokCVdsYZeqbzSb0+Uw1rLLVVLd6YCeeygDead+4ZNnzk1mijsdTsQ/L9jcpk6AOgAvBXN8Aiy00vFYG3PiLKIZnEcWvy0w2tXnKvn+NYYpnw+mVKqdq01s5sUlf27f9PoGhgawxWwrf49wiAhv3RG7LJbhY+hDW/n8YKQE4a3aLO/b/uhjdsj2UZc/e2d+Nfa+5fnp3g1exogUarxu5Esy7hJeQPSvz4tG/CswQ7kaI8hEt3lv/zn+CwaooXTBFrg4dL3ydcH8xBd+L7klcbwkBbXfhxD6gnDPqNNy4/eXIUPYAS+yQfsGDgaW4Q=
  - secure: yCZQ2Oo0+iR2kBOxu11OpjzCPHGBaLZeTsl/s7CObf6Lp7n8L/jfimfHM4+o6w/xuaOXa+nBqETCNhc2KzCTZHusu3DBXb2YQlLugERSgDAW8xQ+bal39vTlC3DRTtRSzEsF58sMRj24cqfZlr7CQzsAdBs+RsMiKBt0wf+vyHFOY+p6o88Pxn37eYW+d8RJ35jtMOjh4dgV5k/ZHtcVlNaZojGX2YqdxIpCHvX7ZKIkvz1s6drATlqiptDVWH17mIY153cKoAi9FP5lDi9bQkwu/Pa0pYMcJR+A2S0n8AUHgkUEuxobDW0ttoDCgfTwd3E+ip50rMNESYonN2bF7h02ViE342aeQW1jKPkpBoqvmCBFUngrv5rgMxEtLHJsb1f2uEIlcelGbW1A2P4h2rJ4G9hcFuRM0HLzsWUA+REMoY9PzgyxbhoY0gNxkO7M+dNK+T6yvZc5M9Xwl5ZeBPnDE/TDevIGL+8HKmoGklFfZNd/uepwFOflwbTKW+P63Km74PRGjjchMZJwxdf+yp2kfm3LxGx9yWB12bq0I2NvUtIBjfncwX8ldzrPHz1ZZLmikchwslBw7ww5CS2/MQfaaerFmc67YcHiCF8ntzulmCHbg/JjIwe7qjwR9o5UCxv5n6q2Ygoo7YReeUxJqoxgC0AHbLQD0h/CHvTddT4=
  - CURRENT_FLOODS_BRANCH_NAME=master
  - S3_BUCKET=ctxfloods-frontend-master
