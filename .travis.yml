language: node_js
node_js:
- node
addons:
  postgresql: 9.4
services:
- postgresql
jobs:
  include:
  - stage: Test Backend Locally
    before_script: cd backend; yarn; yarn init-local-db; yarn local-drop-rebuild
    script: cd backend; yarn postgraphql-local & yarn test
  - stage: Test Frontend Locally
    before_script: cd backend; yarn; yarn init-local-db; yarn local-drop-rebuild;
    script: cd backend; yarn postgraphql-local & cd ../frontend; yarn; yarn get-schema;
      yarn test
  - stage: Deploy Backend to AWS
    before_script: npm install -g serverless
    script: cd backend; yarn; yarn rebuild-and-deploy
  - stage: Test backend against AWS endpoint
    before_script: npm install -g serverless
    script: cd backend; yarn; yarn test-on-aws
    after_script: cd backend; yarn; yarn rebuild-and-deploy
  - stage: Deploy frontend to s3
    script: cd frontend; yarn; yarn build
    deploy:
      provider: s3
      access_key_id: "$AWS_ACCESS_KEY_ID"
      secret_access_key: "$AWS_SECRET_ACCESS_KEY"
      bucket: "$S3_BUCKET"
      skip_cleanup: true
      local_dir: build
      acl: public_read
      on:
        all_branches: true
env:
  global:
  - secure: GxzlCWOlruqVNUNelKJjq24jog/mZbyDnAjRABATEVs0++FwcdZYxk1vd5NpzXfcWwAXXNqmvL9aR4wcg29V9nYES0PCE1oUSne70GZSd/bz5+HQ+go3bz1DCzpUYsBn3evMdtZkzJtKBhaZ/CeANAIKJHimlcO/CQEDB1QPwvy3xJbGNsIzfWyeogvCVI9BDFp8NPSylm9/5K5eUMnpiO9r73R+37hqWVeenFdM0thjyiiE8E6ycZLQDcdes04tH4oe8ots2I7CvpGiGdMOPv6hwr6xmAKlf4XkD5x6oUJNo10FoQ/kOVUCKzNp6So5fpyVe8+xpfmdmrxLaF88nlSjjvI2V8GtYPg7rBuZXd9xm4NJ4fPuZU4ZnaBsB3UhVuObodDwVJzdktCr933h2iUcHhmvh9fsO2NxMRsvj4U/wOd6xNLI1pEpXOf69cg1PdKliRY/N1saFyylPuYwjIbEQXFCHfqt0KtqE5QC9LPW0Ue1/mzMzz2zxoKaQesZGbbkfNrNabDCY6IZgxf1vqb6B4ISL3iif7X167dfxEZqSomOyjsFy6D/b/IN8oeRSdE3OiadPc1230rQPhZNq0dgSijPESfNcgDT87Id81rIZ5XIpxFOXvqcjSVE0vQbSemugJm5m8JU2Xr8cYJMz4/lMkmMufh7nRptvAL3XDE=
  - secure: lrpMDM2gE8PVFPTPozc4kQFbpnltqHTwTsQWYLaCN5NQ0lJTmqakXFXpOPd0uM4oOiHC89Ua9D/EUWxNPteUGQA+uwr41PeSU1qLKcfJKH9ad11iIFozhzRHe4jmnOfmhDXQjKGsIFh2JdF5Dwv3IqcGVnAJxlQOHy8ZTUYNfjn2+Rs0z937P2dOLxZK9LGSYiwd6Fq8v+OXQE/663Y9fJsMqp/R1J05Rzuvp0go/iivjJafusGIefSRb9PTarhlbzBmEu/VQkWT7jP9knxXgv2C1T0YkaRo3rL7i2fdWxyQ7w4pj62JgxSXS6UAUBN/ObJGKztu0PhPLVflCTsg18k/GszBFCF4CpT0ZgbudvY3nHqcEH+fwBizgvyIKw/6ggkaUSifsSude3FiPombDK8Vq4o+1w+AZpL8Asj/hY5Q2wQ8eiBxecfuS35JpmFSaQU4uZWAbPChHH/qs5oomyd1phXAJ6jkOkQEEwcMXGQ5XGKfTiyK5jOYMat2Xe9TQ2vY5BRUDqgH+omjvaMQ+g3nseepw3yv2alKCacuD0+Tpw7eSaLJeBZS9FE+jeLOn2sz9WJZcXrEC+obgbCALfC+qK3uEnLksB+rJ6E5eleINr24yOGOS6qaMFaLUzXQsXbbH2ut3u7OwIb2aR6Ejuek1Mr9Nhwh8pTWHmumIZg=
  - secure: PeTQ78C3WIncNkuBhboPNswf4u9qahA7adomudiUmeKxTu/wC3uqpbTb7Fjo+ttzMupr1ZN2LH715KKTG8hGz6iTox/oJlV4Oe1f2OhuW8Fy6FUZloCJ16WSvRkIaMwZht4GL2L584PtmQKQhl7ztbkhR8QF8qg1xKBJ4n3VDIDGo0UDNbHed1CTvdp18IlF0C91WAFenaORBPAkBJA4SE6HYMUGLwoCJ0ef2froX+zQZq+GYTVm7YYGSBNJhLwPXxE8BqY55NKNgTC0jfRnF10bxjVg1ZpVISzWsnlkN3XoCRW55TV98dR5HYv175wcNRN4HYx3qiPlTP8Gcn6vM2siapvrO1227UHjBTnb5xKLxQ7V9au/7Ywmv24lGOU9fgRS7x3yXwgSIoZjNleHMsRiUOXkSQZ/n+pahz699t14Gg2OKT3pWqzmLw5luvH/W+fnqRllYGAOPKbVkTe8GZVNk3ZWW1hWajgmBwUYi0YHyyWt5rh3FyRJuRejXzaXVwn4HAczXHuamquvHkk84LZO5hrHV2zBxH6TresxHIuAZ9Pi0Ql40y5jDkRnAEq+wj08ApQZXxjIxV37xDExi2szPgaTrhW+gOz9oodYD/5I5OKIUuRWa/jbxgGEoXuNs5IUdyenU/2SrdShB4t/gyYMNi2G5s0JMtHTh6dgKDU=
  - secure: KAGYVH+KQR6L+LecrbEx8hzF3ReZuI041ylck2VCJwFXALSmWUkR7+kOJp8MlvqPvcK78Pgrqnffme19CWraY3UiwZgHklpW2qeWrqoyJ9eJyusdFLqxWxLfmBIQulVuwbDR+kwfSj+ltAvr1TEprN9oYm5jN4bnlBRCtq5b6TIm2x7MkIZjv/fy1F6dx/dBm/PywhHZcagsa9ZswJw1bv5al+KMCwIt6GHDNaRoOteFT0VAJTRSUDtwKNl9reeIATFPpmvx8xh15dcdLVOy+p5zRnn12LpdBKUoChZf5iAfYRBg5xTx7p/h0AePPDJlcNLMSKRdljomITTn+mEHCx0AZ7cUAzKdfyziPi19+o2LK+RLNfDLnu0DFfXxobOB/KAj3TH27kGXxGbkL4hB7w3rfqELvG7t3Bkze1f0exvUqYOI9WqaROJxivM6LqojWbiYfQUwQS77BzsBZTBMjMK604FSkDaLSOgoiLR6WG7sLNj5LP9ZiOxLCvXhofytM+g+he0iFXqTDaQRf8kzkWPH66nDWp3lL4BrcsuLEWbMznmWtTqBmbOwFlFd6ql//7b7RBuscAhwEfjXfeUxaEuGWG+jcyf6/vTFEKW1iEwfANZJnPgTx7G3lMevDs4JVjoLL2U+AIRt+KgTiCY4rQmgeM6acIBKEsCccY72ocY=
  - secure: KLzjhsF4EZY64RvRn3RwTOPphoOQXlYPC9+KnBZc+x75mNO3F1au91E+iudHR0G38/D4n2EgYlUUsfu5QkhpRn3EO1GpJ4stJbsvtXTu8zDmoLsaVa1cOGkApegKVa5BJi51YXdLUvVmmKakbrzaUufZwlGl0XKf6/ahlegyJW+Pol4Bk7KsDmvgCNQQb0WHpu/7Qe6nE7AP6I60E+y49BU7rQ4SFVfKZBVukhRnyG5905XZJc7WmF9mRrkg1ZWSjt/clEGi2rTi6/Ke942M2jExcimUNEyccFbv+467M8CNEs2SbmlZyq8asJfE3kwt9ONrlu7ToFgnaN+l4hk9Q+PIic/Ddi+fjJZrQcXlkOZFFm9zOLS+pU2MAazhprsgzSqKfeFCwkRDJ+P+oF/qsC3P7KwxG0srm/4lKOOqPJUpJUPv4zNUAgQPaKVhD3hN6mpFux4THTuEaJx1GKCua71008jKZl6ukByyJr7TdhTbaIoOXuAVCXUSbRLi0SoqOkXa1GVLl8mCCMwSZAdfJeZuGiPXY1HTTjR933RutcNtxll17bW9IHnxE25BY09f0M0bBXEeI7iTBR5/UYP1qgVjSmoITzQbx1/imvre18PdvQ4UMkZEH8vbmnWjPqdumGt7Z3KXncXbbZmHEd6ZD6J/s1wLloVoP2t8XgNoj60=
  - CURRENT_FLOODS_BRANCH_NAME=betterTravis
  - S3_BUCKET=ctxfloods-frontend-bettertravis
