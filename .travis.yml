language: node_js
node_js:
- node
addons:
  postgresql: 9.4
services:
  - postgresql

jobs:
  include:
    - stage: Test Backend Locally
      before_script: cd backend; yarn; yarn init-local-db; yarn local-drop-rebuild
      script: cd backend; yarn postgraphql-local & yarn test
    - stage: Test Frontend Locally
      script: cd frontend; yarn; yarn test
    - stage: Deploy Backend to AWS
      before_script: npm install -g serverless
      script: cd backend; yarn; ./travisDeploy.sh
    - stage: Test backend against AWS endpoint
      script: cd backend; yarn; yarn test-on-aws
    - stage: Deploy frontend to s3
      script: cd frontend; yarn; yarn build
      deploy:
        provider: s3
        access_key_id: $AWS_ACCESS_KEY
        secret_access_key: $AWS_SECRET_KEY
        bucket: $AWS_S3_BUCKET
        skip_cleanup: true
        local_dir: frontend/build
        all_branches: true
