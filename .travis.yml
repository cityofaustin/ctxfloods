language: node_js
node_js:
- node
addons:
  postgresql: 9.4
services:
- postgresql
jobs:
  include:
  - stage: Test Backend Locally
    before_script: cd backend; yarn; yarn init-local-db; yarn local-drop-rebuild
    script: cd backend; yarn postgraphql-local & yarn test
  - stage: Test Frontend Locally
    before_script: cd backend; yarn; yarn init-local-db; yarn local-drop-rebuild;
    script: cd backend; yarn postgraphql-local & cd ../frontend; yarn; yarn get-schema;
      yarn test
  - stage: Deploy Backend to AWS
    before_script: npm install -g serverless
    script: cd backend; yarn; yarn rebuild-and-deploy
  - stage: Test backend against AWS endpoint
    before_script: npm install -g serverless
    script: cd backend; yarn; yarn test-on-aws
    after_script: cd backend; yarn; yarn rebuild-and-deploy
  - stage: Deploy frontend to s3
    script: cd frontend; yarn; yarn build
    deploy:
      provider: s3
      access_key_id: "$AWS_ACCESS_KEY_ID"
      secret_access_key: "$AWS_SECRET_ACCESS_KEY"
      bucket: "$AWS_S3_BUCKET"
      skip_cleanup: true
      local_dir: build
      acl: public_read
env:
  global:
  - secure: ci3T8yB9Z+u70Cl86UvGYh6unrrFhBSrwroP7OJOjVi4qcexJUH4UFz4FRuZ8YDYvaNIQSpN99ZTxsNnayfCOOx6kiphsNtMxjSUKYZM8kPsJhVGHi9VITWY1my5HlxzzS8Z5HRTq1ZLoWXNx3t4WBqPtrhr1Oej/rIvlff4kV2Zt1UShysriQuj5Wko+DBVqlvYxBab+CnRwlp+HK8IGqFeKlPwO1vFaOA3+i1nGzKNTrFRk/Rbs4ITCvhlLFkSRpErGTfUK9zMlKGswMIg/LmzcyhED8QrBjoZnyY4pnmjQY2ZrcTPzKtdTq7VsMWUm26gcQoKvu2Q61XQkD+c/0+Yng88f+jWrPwy0okSylCTcNQ0pOuK4vlCPxZ0N6KLXeoH5Y1H2pQPUwr7+JAz+zd7impAi6VPcDaRx7BkcSsOE6aEQe2ORE62HGBAL+XpxmtROPQ5QU6gCaznMAyJlaLy7i+jkZVldICLqe46vjaP7L0s6TFvAu/Z8zAlf1gSdg3KHyjKT4phAjLQ8aDwY/Q8prD3x16RgGHztQJTcmL4YSyuEGNWBs6aXljD7l6LvYQWofD5PnFAzf6xTCbKgRLQWgYa0QusoYb0jFgzmNBO+YFnxxpCLho40Yduu3YF7Vf4yXbKDLFwM0y3f2ZfhwEWQ6M84k0i6YDgaGVbSuY=
  - secure: uPxMeKTTUtX+0EF7gLTQ5FeIrmsNRsk2wpf7eEH2c2N4GLeBgbLWR1qf7+6KAHFprXQWCm82r3eCK9JkW7WlkLRi9tDjECADyAef56l9BETaetZaYQMvhYuF5g/cteMG6+KwEuN7VOWF2hJeBW/bKVqpbenBZNL40ThUB/wOVZt4itChk1BMIftf+sEXpFc7e6qpYF/cAWwrvV5jBmP6m0kA7ds0Tr1b5ggh78IDa7/XQVZk9jRH2tNSfI0YmaPGlk83QO//xJmeFIYeMnXGX/F2C3c8VVDE6bhDmfxtxPj5f3VduZ1tXwTJTW7PeXEtbd5ql4CFBadCsenxziJSGNbui42nX9uet+HJNQEsUCb4N9Uk2NUL9Vd/eD4tRA068T8SAKzVwhHw2RtNiR/bEXiFOM3rrUyAY2Fbsw17hp3/0ZjGpvVFMZx+StBpyr3FX2H5YyHKj3zJVWtyOT20pG6gFq0hOu6FSToJymZ60ORJbA28rDTsafiTDZbKmzctKU+wx/YXpa+IDDUXxKSv1Z2qTnq+04vszlezljifESgXgs0hHALeoE5AkRSex1VZIGMAAEt2x/+6dvUn7tq7un9nZSXacAQWYV3TPK6XU2dQHaWqTZ7jxDApr7PQ2pGIInIf2cvvJVBOz3TncfxGUdVcRNOY6ha2Rw8uH2p0qn4=
  - secure: GuQW/AAgCcjqVB/OcCteF2TXxTof6/iSyaDhca/k/RIrdMXqHTZkItsPX5bmaCWqEG3sPvnY9cdq8pJhug4oQO3BAi95/yolZzTiIVPFI48vRFv3ifxNEgV4wuQYpV9Paz9KiKYApLBtJEyVmcr9V+JFsfuKLV3F3aFA6Z3oQOyrWKq63SA3StnWcfjKEoJ4ilwsiEn5BDF1p5jrlLKZesl/gdNZIvCuFpaHHBZmnJhbyGLGfUpGUuPhgtXaxWIMDO8/Eevg+h3JBQymfES1L01r43wVWIS4kApqts0phZNBqIXvUrnCI4dtQXU0D0LKKELqYfiacOfqEBCcnPsTPpRr7RZ/4C4AyN0meRDQ8fmO+JP2mq/1XtdRIeD5FFy+mMaGS+VIgXCH4yu4RLpWjuZr6ZdIFTg3QIf3DKUuUoowbl69ykBBI8BvqPdFZWDLy28+qLguKMAG+LUrb6sjmoaGgjrzZhNhDuBMveJxgrNnkYw++4t7gMd/j6+CEEu0TxtQLUQn/Esl0EGR337uSR2yqwm/XuZLl2I5j8RJs1Ng/47Bx8VfnpmUWHvDGrnVPpHofnjUBL3SH9Tzr6Q1VUtzrT/hfBWy7KsQZaH1I/YewYvDi4zR1t97SLj2rLj1O5xmCKTFxUVGXX7hKSBtiaoV5BzgG8hNI6conYb9eq8=
  - secure: mYtq0TntzTa8zNXEn98qUnUIqTA08u/pcS6y5bUZfvNPvMZa9IXPnPMeQzc2bG61YVDFnJHQZYekCMsjh3+MIQnY+nFCk/JmN51f/yqOBzhSrFqNd2IgaKBPFZnJLg/WELDegEGyP3zWBhoY0hi0y+2abRXtWR1pnPdE3vKfh4DpSd/X9YAKjmnzSDUY/TiKz437zi81NQs6lrfW1nf90RkHQw6yFLXOcSsrdCKa07iyfigGdGGipk+zLcosZ3VNKdqKKZ89bL9shb3Kvc5FUYIqGXnV74oDbwdnwAVXryxbhd7EFsoK+Ms7jQCEiYltk+9faQ3Q/dC0VBfc2swITZJNVy+1U1WuY9fN35vo4+u5iK4pNh15odU4tIEerqB4KNRpiJ/UVdbBvnWN29NO+kgfukSmvvz050InrFwwXZhZ0WQXm3hWCjA0iE/gKiFz9x3gnefnCLoVNTNUK7KlXLlgTsb3Rg3s1k9F/VZQNde+0Cx4vbkGO0/VFzsAFRm8B4em6noEHmiYhOpeG21woqAr2y6VBNfQLXJoVSJFI2S1YtVXXeJUqsXlP2k7OYQtujlnRgWzraz1yE1bmRYbcNrkk9vfDJtKWhd5flF+u7IwTD5lo/o7sygmAEr3+ltttmYOY7FY4c0vM79Fve1LdHHvwT8LXrGaZeNoZ26yKOw=
  - secure: Vx16av6tH4Lyb91mmXfUgKnwFFe5p5LIqr7T5U/oXFt9Y7U4nLDwqn7k25NvgDgBPKix+5nJFfH++c2WzmgPrdwoTSDIRLM1j8QPkLtqrqu6LBXzBt/nbC0/tzCNJ03IOY2tnC7mYGqk/aez+vB9mbqQoVE4qlUHMyQgd2k4X1JfQNA1PqS2a7aZ2XyCclWx0eM9GtUyPHFfYomde8ogji0WVrQssm4iv2Ztl+kv0lCWozJ9uWnoECd41kokQGJVdOV+sWijaFzqSJpPhlyTrP5AJSsz8SHtfurxVqDxu+TOAfv8or2ouNjNM4/uB5uoT0bz3LsuGodTIHyfJ4ze4fm5+V4qifM77RixWMG6Os9+jW2cmVurw8yplqwmV24TqR4bl74KGsSdiV6HigeoSbk8pqaylI+ByqxsbfykQPP1JH0bCZe2rWEXcRBkshwp9q8FSknXNRqthJW5T1/AUR/yCc/KXo2kwlrUaz8DJZFrF4QzJA65BGUZG0UrcoeQEGqupWRVh6iYxyB8laGJf/tu6DdqgBTQqG2Us7c9uXUl/bZP8akTp69Nj005pbBMyIyLJKrDT9WsV4Hmp3dhCpV5KgaysSv6gFP0/ES+9UF1cMNR+91MUp2oDDnlYSI82A9ZTAdXNY+HpZWfO1UM2gOy6dowMhj3iZcS33/eUyI=
